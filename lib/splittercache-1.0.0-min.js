"use strict";if("undefined"==typeof _||!_)throw"ERROR: Underscore is required for fi.fmi.metoclient.metolib.SplitterCache!";if("undefined"==typeof async||!async)throw"ERROR: Async is required for fi.fmi.metoclient.metolib.SplitterCache!";var fi=fi||{};fi.fmi=fi.fmi||{},fi.fmi.metoclient=fi.fmi.metoclient||{},fi.fmi.metoclient.metolib=fi.fmi.metoclient.metolib||{},fi.fmi.metoclient.metolib.SplitterCache=function(){var e=function(e){var t,i=0;if(!_.isObject(e))throw"taskdef must be an object";if(!_.isString(e.service))throw"taskDef must contain a 'service' property of string type";if(!_.isArray(e.location)){if(!_.isString(e.location))throw"taskDef must contain a 'location' property of either an array or a string type";t=e.location,e.location=[],e.location.push(t)}if(!_.isArray(e.parameter)){if(!_.isString(e.parameter))throw"taskDef must contain a 'parameter' property of either an array or a string type";t=e.parameter,e.parameter=[],e.parameter.push(t)}if(!_.isNumber(e.resolution))throw"taskDef must contain a 'resolution' property of numeric type";if(!(e.resolution>.5))throw"taskDef.resolution must be a positive integer";if(e.resolution=Math.round(e.resolution),!_.isNumber(e.start))throw"taskDef must contain a 'start' property of numeric type";if(_.isNumber(e.pointCount)){if(!(e.pointCount>0))throw"taskDef.pointCount must be greater than zero";e.end=e.start+(e.pointCount-1)*e.resolution}else{if(!_.isNumber(e.end))throw"taskDef must contain either 'end' or 'pointCount' property of numeric type";if(e.end<e.start)throw"'end' must be greater than or equal to 'start'";i=(e.end-e.start)%e.resolution,0!==i&&(e.end=e.end+(e.resolution-i)),e.pointCount=(e.end-e.start)/e.resolution+1}},t=function(e,t){var i=0;if(_.isArray(e)&&_.isArray(t)){if(e.length===t.length){for(i=0;e.length>i;i++)if(-1===_.indexOf(t,e[i]))return!1;return!0}return!1}return void 0===e||null===e||void 0===t||null===t?!1:e===t},i=function(){var t=0,i=function(i){function n(){o=null,a=null,c=null,s=null,u=0,l=!1,f=!1,h=!1,d=!1,E=!1,m=[]}var r=null,o=null,a=null,c=null,s=null,u=0,l=!1,f=!1,h=!1,d=!1,E=!1,m=[],T=i,p=this;this.getId=function(){return r},this.getTaskDef=function(){return s},this.getStart=function(){return null!==s?s.start:void 0},this.getEnd=function(){return null!==s?s.end:void 0},this.getPointCount=function(){return null!==s?s.pointCount:void 0},this.getResolution=function(){return null!==s?s.resolution:void 0},this.getService=function(){return null!==s?s.service:void 0},this.getLocation=function(){return null!==s?s.location:void 0},this.getParameter=function(){return null!==s?s.parameter:void 0},this.getDataSize=function(){return null!==s?s.pointCount*s.parameter.length*s.location.length:0},this.pin=function(){return d?!1:(h||(h=!0,T&&T("blockPinned",p)),!0)},this.unpin=function(){h&&(h=!1,T&&T("blockUnpinned",p))},this.isPinned=function(){return h},this.isWaitingRecycling=function(){return d},this.increaseNotUsed=function(){u++,T&&T("blockAged",p)},this.getNotUsedSince=function(){return u},this.markForRecycling=function(){d=!0,T&&T("blockEvicted",p)},this.recycle=function(){n(),T&&T("blockRecycled",p)},this.prepare=function(t,i){if(!_.isFunction(i))throw"fetcher must be a function";e(t),n(),s=t,a=i,E=!0,T&&T("blockPrepared",p)},this.getDataAsync=function(e){var t=this;if(!E)throw"Cannot getData in unprepared state, call prepare first";u=0,f?_.isFunction(e)?(_.defer(function(i,n){T&&T("blockCacheFetchFinished",p),e(i,n),t.unpin()},o,c),T&&T("blockCacheFetchStarted",p)):t.unpin():(void 0!==e&&_.isFunction(e)&&m.push(e),l||(l=!0,a(s,function(e,i){e&&(o=e),c=i,f=!0,T&&T("blockProviderFetchFinished",p),0===m.length?(l=!1,t.unpin()):async.each(m,function(e,i){try{e.call(t,o,c)}catch(n){}i()},function(){m=[],l=!1,t.unpin()})}),T&&T("blockProviderFetchStarted",p)))},r="id#"+t++,T&&T("blockCreated",p)};return i}(),n=0,r=0,o=function(o){function a(e,t){void 0!==C[e]&&_.each(C[e],function(e){try{e.call(b,t)}catch(i){}})}function c(e,t){var i=null;if(void 0===C[e])throw"Unknown event '"+e+"', use one of "+_.reduce(_.keys(C),function(e,t,i){return i>0&&(e+=", "),e+=t});if(!_.isFunction(t))throw"Event listener callback is not a function";return i="id"+n++,C[e][i]=t,i}function s(e,t){if(void 0===C[e])throw"Unknown event '"+e+"', use one of "+_.reduce(_.keys(C),function(e,t,i){i>0&&(e+=", "),e+=t});void 0!==C[e][t]&&delete C[e][t]}function u(e){async.each(e,function(e,t){e.markForRecycling(),t()},function(e){e&&console.error(e)})}function l(){var e;return e=M.length>0?M.pop():new i(a)}function f(e,t,i,n){var r=!1;return e===i&&t===n?r=!0:n>=e&&t>i&&(r=!0),r}function h(e,t,i,n,r,o){var a=null;return(0===e||i-o.resolution>t)&&i>n&&(a=i>=r?null===t?E(o,n,r):E(o,Math.max(t,n),r):null===t?E(o,n,i):E(o,Math.max(t,n),i)),a}function d(e){var i=[],n=e.start,r=e.end,o=Math.ceil(L*e.pointCount),c=Math.ceil(y*e.pointCount),s=n-o*e.resolution,l=r+c*e.resolution,d=[],m=[];return I=0,v.length>0&&_.each(v,function(n,r){var o=!1,a=null,c=null,u=0===r?null:v[r-1].getEnd(),T=n.getStart(),p=n.getEnd();if(n.isWaitingRecycling())return n.isPinned()?async.whilst(function(){return n.isPinned()},function(e){setTimeout(e,500)},function(){n.recycle(),M.push(n)}):(n.recycle(),M.push(n)),void 0;m.push(n),e.service===n.getService()&&t(e.location,n.getLocation())&&t(e.parameter,n.getParameter())?(a=h(r,u,T,s,l,e),null!==a&&a.length>0&&(Array.prototype.push.apply(m,a),async.reduce(a,X,function(e,t,i){i(null,e+t.getDataSize())},function(e,t){X=t}),Array.prototype.push.apply(i,a)),o=f(T,p,s,l),o?n.pin()?(i.push(n),A+=n.getDataSize()):console&&console.error("Strange, unable to pin block!"):n.increaseNotUsed(),r===v.length-1&&l>p&&(c=E(e,p,l),Array.prototype.push.apply(m,c),async.reduce(c,X,function(e,t,i){i(null,e+t.getDataSize())},function(e,t){X=t}),Array.prototype.push.apply(i,c))):n.increaseNotUsed();var R=_.sortedIndex(d,n,function(e){return e.getNotUsedSince()});d.splice(R,0,n),I+=n.getDataSize()}),0===i.length&&(i=E(e,s,l),Array.prototype.push.apply(m,i),async.reduce(i,X,function(e,t,i){i(null,e+t.getDataSize())},function(e,t){X=t})),v=[],v=m,m=[],async.whilst(function(){return 1.01*I>S},function(){var e=1.01*I-S;a("evictStarted",{inCache:I,toEvict:e});for(var t=[],i=null,n=0;e>n&&d.length>0;)i=d.pop(),void 0!==i&&(n+=i.getDataSize(),t.push(i));t.length>0&&(u(t),I-=n,a("evictFinished",{inCache:I,evicted:n}))},function(){}),i}function E(e,t,i){var n,r=[],o=Math.round((i-t)/e.resolution)+1,a=Math.ceil(o/g),c=0,s=null;for(c=0;a>c;c++)s=l(),n=_.clone(e),n.start=t+c*e.resolution*g,n.pointCount=Math.min(g,o-c*g),n.end=n.start+(n.pointCount-1)*e.resolution,s.prepare(n,p(e.service)),s.pin()?r.push(s):console.error("Strange, unable to pin block!");return r}function m(e,t,i,n,r,o,a,c){var s=_.isObject(t);async.each(i,function(i,c){void 0===e.data[i]&&(e.data[i]={}),async.each(n,function(n,c){var u=!1;void 0===e.data[i][n]&&(e.data[i][n]=[]),s&&(_.isObject(t[i])&&_.isArray(t[i][n])?o+a>t[i][n].length&&(u=!0,console&&console.error("The service returned "+t[i][n].length+" values for location "+i+" and parameter "+n+" when "+(o+a)+" were requested. Filling the whole segment with NaN")):u=!0);for(var l=0;a>l;l++)e.data[i][n][r+l]=s?u?0/0:t[i][n][o+l]:t;c()},function(){c()})},function(){c()})}function T(e,t,i){var n={},r=null,o=!1;if(!_.isFunction(t))throw"finishCallback must be a function";if(_.isFunction(i)&&(o=!0),null===p(e.service))throw"No data fetcher set for service '"+e.service+"', unable to provide data";void 0!==O[e.service]&&(O[e.service].resolution!==e.resolution||0!==Math.abs(O[e.service].start-e.start)%e.resolution)&&R(e.service),O[e.service]={start:e.start,resolution:e.resolution};var c=d(e);n.steps=_.range(e.start,e.end+e.resolution,e.resolution),n.data={},async.each(c,function(t,a){var c=t.getTaskDef(),s=0/0,u=0/0,l=0/0,h=0/0,d=0/0,E=0/0;return f(c.start,c.end,e.start,e.end)?(c.start<e.start?(s=e.start,d=Math.round((e.start-c.start)/e.resolution)):(s=c.start,d=0),l=_.indexOf(n.steps,s,!0),c.end>e.end?(u=e.end,h=n.steps.length-1):(u=c.end,h=_.indexOf(n.steps,c.end,!0)),E=h-l+1,t.getDataAsync(function(e,t){var f=t;e&&(null===r&&(r=[]),r.push({start:c.start,end:c.end,error:e}),t||(f=0/0)),m(n,f,c.location,c.parameter,l,d,E,function(){o&&i(e,s,u),a()})}),void 0):(t.getDataAsync(),a(),void 0)},function(){t(r,n),a("fetchFinished",e)})}function p(e){return void 0!==P[e]?(P[e].nextIndex=(P[e].nextIndex+1)%P[e].providers.length,P[e].providers[P[e].nextIndex].cb):null}function R(e){_.each(v,function(t){(void 0===e||t.getService()===e)&&t.markForRecycling()}),a("cacheCleared",e)}var M=[],v=[],O=[],L=.5,y=1,g=500,S=5e4,P={},I=0,A=0,X=0,b=this,C={blockCreated:{},blockPrepared:{},blockProviderFetchStarted:{},blockProviderFetchFinished:{},blockCacheFetchStarted:{},blockCacheFetchFinished:{},blockPinned:{},blockUnpinned:{},blockEvicted:{},blockRecycled:{},blockAged:{},evictStarted:{},evictFinished:{},fetchStarted:{},fetchFinished:{},cacheCleared:{},dataProviderAdded:{},dataProviderRemoved:{}};this.addDataProvider=function(e,t){var i={};if(!_.isFunction(t))throw"Fetcher must be a function";return void 0===P[e]&&(P[e]={nextIndex:0,providers:[]}),i.id="id#"+r++,i.cb=t,P[e].providers.push(i),a("dataProviderAdded",{service:e,providerId:i.id}),i.id},this.removeDataProvider=function(e,t){var i=0,n=!1;void 0!==P[e]&&(i=P[e].providers.length,P[e].providers=_.reject(P[e].providers,function(e){return e.id===t}),0===P[e].providers.length?(delete P.service,n=!0):i!==P[e].providers.length&&(n=!0),n&&a("dataProviderRemoved",{service:e,providerId:t}))},this.clearCache=function(){R(),O=[],A=0,X=0},this.fetch=function(t,i,n){e(t),a("fetchStarted",t),T(t,i,n)},this.getCachedItemCount=function(){return I},this.getFillingDegree=function(){return I/S},this.getHitRatio=function(){return A/(A+X)},this.addListener=function(e,t){return c(e,t)},this.removeListener=function(e,t){return s(e,t)},void 0!==o.sideFetchBeforeFactor&&_.isNumber(o.sideFetchBeforeFactor)&&o.sideFetchBeforeFactor>=0&&(L=o.sideFetchBeforeFactor),void 0!==o.sideFetchAfterFactor&&_.isNumber(o.sideFetchAfterFactor)&&o.sideFetchAfterFactor>=0&&(y=o.sideFetchAfterFactor),void 0!==o.maxBlockDataPoints&&_.isNumber(o.maxBlockDataPoints)&&o.maxBlockDataPoints>0&&(g=o.maxBlockDataPoints),void 0!==o.maxCacheDataSize&&_.isNumber(o.maxCacheDataSize)&&o.maxCacheDataSize>0&&(S=o.maxCacheDataSize)};return o}();