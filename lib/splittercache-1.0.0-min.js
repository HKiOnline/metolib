"use strict";if("undefined"==typeof _||!_)throw"ERROR: Underscore is required for fi.fmi.metoclient.metolib.SplitterCache!";if("undefined"==typeof async||!async)throw"ERROR: Async is required for fi.fmi.metoclient.metolib.SplitterCache!";var fi=fi||{};fi.fmi=fi.fmi||{},fi.fmi.metoclient=fi.fmi.metoclient||{},fi.fmi.metoclient.metolib=fi.fmi.metoclient.metolib||{},fi.fmi.metoclient.metolib.SplitterCache=function(){var a=function(a){var b,c=0;if(!_.isObject(a))throw"taskdef must be an object";if(!_.isString(a.service))throw"taskDef must contain a 'service' property of string type";if(!_.isArray(a.location)){if(!_.isString(a.location))throw"taskDef must contain a 'location' property of either an array or a string type";b=a.location,a.location=[],a.location.push(b)}if(!_.isArray(a.parameter)){if(!_.isString(a.parameter))throw"taskDef must contain a 'parameter' property of either an array or a string type";b=a.parameter,a.parameter=[],a.parameter.push(b)}if(!_.isNumber(a.resolution))throw"taskDef must contain a 'resolution' property of numeric type";if(!(a.resolution>.5))throw"taskDef.resolution must be a positive integer";if(a.resolution=Math.round(a.resolution),!_.isNumber(a.start))throw"taskDef must contain a 'start' property of numeric type";if(_.isNumber(a.pointCount)){if(!(a.pointCount>0))throw"taskDef.pointCount must be greater than zero";a.end=a.start+(a.pointCount-1)*a.resolution}else{if(!_.isNumber(a.end))throw"taskDef must contain either 'end' or 'pointCount' property of numeric type";if(a.end<a.start)throw"'end' must be greater than or equal to 'start'";c=(a.end-a.start)%a.resolution,0!==c&&(a.end=a.end+(a.resolution-c)),a.pointCount=(a.end-a.start)/a.resolution+1}},b=function(a,b){var c=0;if(_.isArray(a)&&_.isArray(b)){if(a.length===b.length){for(c=0;c<a.length;c++)if(-1===_.indexOf(b,a[c]))return!1;return!0}return!1}return void 0===a||null===a||void 0===b||null===b?!1:a===b},c=function(){var b=0,c=function(c){function d(){f=null,g=null,h=null,i=null,j=0,k=!1,l=!1,m=!1,n=!1,o=!1,p=[]}var e=null,f=null,g=null,h=null,i=null,j=0,k=!1,l=!1,m=!1,n=!1,o=!1,p=[],q=c,r=this;this.getId=function(){return e},this.getTaskDef=function(){return i},this.getStart=function(){return null!==i?i.start:void 0},this.getEnd=function(){return null!==i?i.end:void 0},this.getPointCount=function(){return null!==i?i.pointCount:void 0},this.getResolution=function(){return null!==i?i.resolution:void 0},this.getService=function(){return null!==i?i.service:void 0},this.getLocation=function(){return null!==i?i.location:void 0},this.getParameter=function(){return null!==i?i.parameter:void 0},this.getDataSize=function(){return null!==i?i.pointCount*i.parameter.length*i.location.length:0},this.pin=function(){return n?!1:(m||(m=!0,q&&q("blockPinned",r)),!0)},this.unpin=function(){m&&(m=!1,q&&q("blockUnpinned",r))},this.isPinned=function(){return m},this.isWaitingRecycling=function(){return n},this.increaseNotUsed=function(){j++,q&&q("blockAged",r)},this.getNotUsedSince=function(){return j},this.markForRecycling=function(){n=!0,q&&q("blockEvicted",r)},this.recycle=function(){d(),q&&q("blockRecycled",r)},this.prepare=function(b,c){if(!_.isFunction(c))throw"fetcher must be a function";a(b),d(),i=b,g=c,o=!0,q&&q("blockPrepared",r)},this.getDataAsync=function(a){var b=this;if(!o)throw"Cannot getData in unprepared state, call prepare first";j=0,l?_.isFunction(a)?(_.defer(function(c,d){q&&q("blockCacheFetchFinished",r),a(c,d),b.unpin()},f,h),q&&q("blockCacheFetchStarted",r)):b.unpin():(void 0!==a&&_.isFunction(a)&&p.push(a),k||(k=!0,g(i,function(a,c){a&&(f=a),h=c,l=!0,q&&q("blockProviderFetchFinished",r),0===p.length?(k=!1,b.unpin()):async.each(p,function(a,c){try{a.call(b,f,h)}catch(d){}c()},function(){p=[],k=!1,b.unpin()})}),q&&q("blockProviderFetchStarted",r)))},e="id#"+b++,q&&q("blockCreated",r)};return c}(),d=0,e=0,f=function(f){function g(a,b){void 0!==F[a]&&_.each(F[a],function(a){try{a.call(E,b)}catch(c){}})}function h(a,b){var c=null;if(void 0===F[a])throw"Unknown event '"+a+"', use one of "+_.reduce(_.keys(F),function(a,b,c){return c>0&&(a+=", "),a+=b});if(!_.isFunction(b))throw"Event listener callback is not a function";return c="id"+d++,F[a][c]=b,c}function i(a,b){if(void 0===F[a])throw"Unknown event '"+a+"', use one of "+_.reduce(_.keys(F),function(a,b,c){c>0&&(a+=", "),a+=b});void 0!==F[a][b]&&delete F[a][b]}function j(a){async.each(a,function(a,b){a.markForRecycling(),b()},function(a){a&&console.error(a)})}function k(){var a;return a=t.length>0?t.pop():new c(g)}function l(a,b,c,d){var e=!1;return a===c&&b===d?e=!0:d>=a&&b>c&&(e=!0),e}function m(a,b,c,d,e,f){var g=null;return(0===a||b<c-f.resolution)&&c>d&&(g=c>=e?null===b?o(f,d,e):o(f,Math.max(b,d),e):null===b?o(f,d,c):o(f,Math.max(b,d),c)),g}function n(a){var c=[],d=a.start,e=a.end,f=Math.ceil(w*a.pointCount),h=Math.ceil(x*a.pointCount),i=d-f*a.resolution,k=e+h*a.resolution,n=[],p=[];return B=0,u.length>0&&_.each(u,function(d,e){var f=!1,g=null,h=null,j=0===e?null:u[e-1].getEnd(),q=d.getStart(),r=d.getEnd();if(d.isWaitingRecycling())return d.isPinned()?async.whilst(function(){return d.isPinned()},function(a){setTimeout(a,500)},function(){d.recycle(),t.push(d)}):(d.recycle(),t.push(d)),void 0;p.push(d),a.service===d.getService()&&b(a.location,d.getLocation())&&b(a.parameter,d.getParameter())?(g=m(e,j,q,i,k,a),null!==g&&g.length>0&&(Array.prototype.push.apply(p,g),async.reduce(g,D,function(a,b,c){c(null,a+b.getDataSize())},function(a,b){D=b}),Array.prototype.push.apply(c,g)),f=l(q,r,i,k),f?d.pin()?(c.push(d),C+=d.getDataSize()):console&&console.error("Strange, unable to pin block!"):d.increaseNotUsed(),e===u.length-1&&k>r&&(h=o(a,r,k),Array.prototype.push.apply(p,h),async.reduce(h,D,function(a,b,c){c(null,a+b.getDataSize())},function(a,b){D=b}),Array.prototype.push.apply(c,h))):d.increaseNotUsed();var s=_.sortedIndex(n,d,function(a){return a.getNotUsedSince()});n.splice(s,0,d),B+=d.getDataSize()}),0===c.length&&(c=o(a,i,k),Array.prototype.push.apply(p,c),async.reduce(c,D,function(a,b,c){c(null,a+b.getDataSize())},function(a,b){D=b})),u=[],u=p,p=[],async.whilst(function(){return 1.01*B>z},function(){var a=1.01*B-z;g("evictStarted",{inCache:B,toEvict:a});for(var b=[],c=null,d=0;a>d&&n.length>0;)c=n.pop(),void 0!==c&&(d+=c.getDataSize(),b.push(c));b.length>0&&(j(b),B-=d,g("evictFinished",{inCache:B,evicted:d}))},function(){}),c}function o(a,b,c){var d,e=[],f=Math.round((c-b)/a.resolution)+1,g=Math.ceil(f/y),h=0,i=null;for(h=0;g>h;h++)i=k(),d=_.clone(a),d.start=b+h*a.resolution*y,d.pointCount=Math.min(y,f-h*y),d.end=d.start+(d.pointCount-1)*a.resolution,i.prepare(d,r(a.service)),i.pin()?e.push(i):console.error("Strange, unable to pin block!");return e}function p(a,b,c,d,e,f,g,h){var i=_.isObject(b);async.each(c,function(c,h){void 0===a.data[c]&&(a.data[c]={}),async.each(d,function(d,h){var j=!1;void 0===a.data[c][d]&&(a.data[c][d]=[]),i&&(_.isObject(b[c])&&_.isArray(b[c][d])?b[c][d].length<f+g&&(j=!0,console&&console.error("The service returned "+b[c][d].length+" values for location "+c+" and parameter "+d+" when "+(f+g)+" were requested. Filling the whole segment with NaN")):j=!0);for(var k=0;g>k;k++)a.data[c][d][e+k]=i?j?0/0:b[c][d][f+k]:b;h()},function(){h()})},function(){h()})}function q(a,b,c){var d={},e=null,f=!1;if(!_.isFunction(b))throw"finishCallback must be a function";if(_.isFunction(c)&&(f=!0),null===r(a.service))throw"No data fetcher set for service '"+a.service+"', unable to provide data";void 0!==v[a.service]&&(v[a.service].resolution!==a.resolution||0!==Math.abs(v[a.service].start-a.start)%a.resolution)&&s(a.service),v[a.service]={start:a.start,resolution:a.resolution};var h=n(a);d.steps=_.range(a.start,a.end+a.resolution,a.resolution),d.data={},async.each(h,function(b,g){var h=b.getTaskDef(),i=0/0,j=0/0,k=0/0,m=0/0,n=0/0,o=0/0;return l(h.start,h.end,a.start,a.end)?(h.start<a.start?(i=a.start,n=Math.round((a.start-h.start)/a.resolution)):(i=h.start,n=0),k=_.indexOf(d.steps,i,!0),h.end>a.end?(j=a.end,m=d.steps.length-1):(j=h.end,m=_.indexOf(d.steps,h.end,!0)),o=m-k+1,b.getDataAsync(function(a,b){var l=b;a&&(null===e&&(e=[]),e.push({start:h.start,end:h.end,error:a}),b||(l=0/0)),p(d,l,h.location,h.parameter,k,n,o,function(){f&&c(a,i,j),g()})}),void 0):(b.getDataAsync(),g(),void 0)},function(){b(e,d),g("fetchFinished",a)})}function r(a){return void 0!==A[a]?(A[a].nextIndex=(A[a].nextIndex+1)%A[a].providers.length,A[a].providers[A[a].nextIndex].cb):null}function s(a){_.each(u,function(b){(void 0===a||b.getService()===a)&&b.markForRecycling()}),g("cacheCleared",a)}var t=[],u=[],v=[],w=.5,x=1,y=500,z=5e4,A={},B=0,C=0,D=0,E=this,F={blockCreated:{},blockPrepared:{},blockProviderFetchStarted:{},blockProviderFetchFinished:{},blockCacheFetchStarted:{},blockCacheFetchFinished:{},blockPinned:{},blockUnpinned:{},blockEvicted:{},blockRecycled:{},blockAged:{},evictStarted:{},evictFinished:{},fetchStarted:{},fetchFinished:{},cacheCleared:{},dataProviderAdded:{},dataProviderRemoved:{}};this.addDataProvider=function(a,b){var c={};if(!_.isFunction(b))throw"Fetcher must be a function";return void 0===A[a]&&(A[a]={nextIndex:0,providers:[]}),c.id="id#"+e++,c.cb=b,A[a].providers.push(c),g("dataProviderAdded",{service:a,providerId:c.id}),c.id},this.removeDataProvider=function(a,b){var c=0,d=!1;void 0!==A[a]&&(c=A[a].providers.length,A[a].providers=_.reject(A[a].providers,function(a){return a.id===b}),0===A[a].providers.length?(delete A.service,d=!0):c!==A[a].providers.length&&(d=!0),d&&g("dataProviderRemoved",{service:a,providerId:b}))},this.clearCache=function(){s(),v=[],C=0,D=0},this.fetch=function(b,c,d){a(b),g("fetchStarted",b),q(b,c,d)},this.getCachedItemCount=function(){return B},this.getFillingDegree=function(){return B/z},this.getHitRatio=function(){return C/(C+D)},this.addListener=function(a,b){return h(a,b)},this.removeListener=function(a,b){return i(a,b)},void 0!==f.sideFetchBeforeFactor&&_.isNumber(f.sideFetchBeforeFactor)&&f.sideFetchBeforeFactor>=0&&(w=f.sideFetchBeforeFactor),void 0!==f.sideFetchAfterFactor&&_.isNumber(f.sideFetchAfterFactor)&&f.sideFetchAfterFactor>=0&&(x=f.sideFetchAfterFactor),void 0!==f.maxBlockDataPoints&&_.isNumber(f.maxBlockDataPoints)&&f.maxBlockDataPoints>0&&(y=f.maxBlockDataPoints),void 0!==f.maxCacheDataSize&&_.isNumber(f.maxCacheDataSize)&&f.maxCacheDataSize>0&&(z=f.maxCacheDataSize)};return f}();