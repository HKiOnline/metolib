"use strict";if("undefined"==typeof jQuery||!jQuery)throw"ERROR: jQuery is required for fi.fmi.metoclient.metolib.WfsConnection!";if("undefined"==typeof _||!_)throw"ERROR: Underscore is required for fi.fmi.metoclient.metolib.WfsConnection!";if("undefined"==typeof async||!async)throw"ERROR: Async is required for fi.fmi.metoclient.metolib.WfsConnection!";var fi=fi||{};if(fi.fmi=fi.fmi||{},fi.fmi.metoclient=fi.fmi.metoclient||{},fi.fmi.metoclient.metolib=fi.fmi.metoclient.metolib||{},!fi.fmi.metoclient.metolib.Utils)throw"ERROR: fi.fmi.metoclient.metolib.Utils is required for fi.fmi.metoclient.metolib.WfsConnection!";if(!fi.fmi.metoclient.metolib.SplitterCache)throw"ERROR: fi.fmi.metoclient.metolib.SplitterCache is required for fi.fmi.metoclient.metolib.WfsConnection!";if(!fi.fmi.metoclient.metolib.WfsRequestParser)throw"ERROR: fi.fmi.metoclient.metolib.WfsRequestParser is required for fi.fmi.metoclient.metolib.WfsConnection!";fi.fmi.metoclient.metolib.WfsConnection=function(){function e(e){return jQuery.trim(e).replace(/,\s+/,l)}function t(t){var i=[];if(_.isString(t))i.push(e(t));else if(_.isArray(t))for(var n=0;t.length>n;++n){var r=t[n];r&&i.push(e(r))}return i}function i(e,t,i){var n=i;if(e&&e.location&&t&&i){var r=i+f,o=t.indexOf(r);0===o&&(t=jQuery.trim(t.slice(r.length)));for(var a=t+l+i,c=0;e.location.length>c;++c){var s=e.location[c];if(-1!==s.indexOf(l)&&s===a){n=s;break}}}return n}function n(e,t){if(_.isArray(e)&&t&&t>0)for(var i=1;e.length>i;++i){var n=e[i-1],r=e[i];if(_.isObject(r)){var o=_.isObject(n)?n.time:void 0,a=r.time;void 0!==o&&null!==o&&void 0!==a&&null!==a&&a-o>t&&(a=o+t,e.splice(i,0,{time:a,value:0/0})),o=a}}}function r(e,t){return _.find(e,function(e){return _.isEqual(e,t)})}function o(e){var t=[];if(_.isArray(e))for(var i=0;e.length>i;++i){var n=e[i],o=_.isObject(n)&&(n.errorCode||n.errorText);if(_.isObject(n)&&_.isArray(n.error)&&n.error.length>0)for(var a=n.error,c=0;a.length>c;++c){var s=a[c];if(_.isObject(s)&&(s.errorCode||s.errorText)){var u={errorCode:s.errorCode,errorText:s.errorText,extension:n};r(t,u)||t.push(u)}else o=!0}else o=!0;if(o){var l={errorCode:_.isObject(n)?n.errorCode:void 0,errorText:_.isObject(n)&&_.isString(n.errorText)?n.errorText:h,extension:n};r(t,l)||t.push(l)}}return t}function a(e,t,r){var o={data:t?{}:void 0,errors:r};return t&&_.each(t.locations,function(r){var a=i(e,r.info.name,r.info.region);o.data[a]||(o.data[a]={}),_.each(r.data,function(i,c){o.data[a][c]||(o.data[a][c]=[]),n(i.timeValuePairs,e.resolution),_.each(i.timeValuePairs,function(e){var n={info:t.info,properties:t.properties,locationInfo:r.info,blockProperty:i.property,timeValuePair:e};o.data[a][c].push(n)})})}),o}function c(e,t,i){var n={data:t?{info:void 0,properties:void 0,locations:[]}:void 0,errors:o(i)};return t&&_.each(t.data,function(e){var t={info:void 0,data:{}};_.each(e,function(e,i){var r={property:void 0,timeValuePairs:[]};_.each(e,function(e){e&&(n.data.info||(n.data.info=e.info),n.data.properties||(n.data.properties=e.properties),r.property||(r.property=e.blockProperty),t.info||(t.info=e.locationInfo),r.timeValuePairs.push(e.timeValuePair))}),t.data[i]=r}),n.data.locations.push(t)}),n}function s(e,t,i){fi.fmi.metoclient.metolib.WfsRequestParser.getData({url:e.connectionUrl,storedQueryId:e.storedQueryId,requestParameter:t.parameter,begin:t.start,end:t.end,timestep:t.resolution,denyTimeAdjusting:!0,sites:t.location,callback:function(n,r){var o=a.call(e,t,n,r);i(o.errors,o.data)}})}var u="parserSites",l=",",f=" ",h="ERROR: Cache found error(s)!",d=function(e){if(e.timestep&&1!==e.timestep){var i=e.begin,n=e.end,r=e.timestep;e.denyTimeAdjusting||(i=fi.fmi.metoclient.metolib.WfsRequestParser.adjustBeginTime(r,i),n=fi.fmi.metoclient.metolib.WfsRequestParser.adjustEndTime(r,n,i));var o={service:u,parameter:_.isString(e.requestParameter)?e.requestParameter.split(l):e.requestParameter,start:i instanceof Date?i.getTime():i,end:n instanceof Date?n.getTime():n,resolution:r,location:t(e.sites)};this.cache.fetch(o,function(t,i){var n=c(o,i,t);e.callback(n.data,n.errors)},e.progressCallback)}else{var a=this;fi.fmi.metoclient.metolib.WfsRequestParser.getData({url:a.connectionUrl,storedQueryId:a.storedQueryId,requestParameter:e.requestParameter,begin:e.begin,end:e.end,timestep:e.timestep,denyTimeAdjusting:e.denyTimeAdjusting,sites:t(e.sites),callback:e.callback})}},m=function(e){var t=this;fi.fmi.metoclient.metolib.WfsRequestParser.getData({url:t.connectionUrl,storedQueryId:t.storedQueryId,requestParameter:e.requestParameter,begin:e.begin,end:e.end,timestep:e.timestep,denyTimeAdjusting:e.denyTimeAdjusting,bbox:e.bbox,callback:e.callback})},E=function(e,t){var i=!0;try{var n=Array.prototype.slice.call(arguments);n.shift(),n.shift(),e.apply(this,n)}catch(r){var o="ERROR: API level error occurred in a synchronous flow!";if(console.error(o),i=!1,t){var a={errorText:o};t(void 0,a)}}return i},p=function(){return this.connectionUrl},R=function(){return this.storedQueryId},T=function(e,t){if(!this.connectionUrl){if(!_.isString(e)||!e){var i="ERROR: WfsConnection URL must be a string and not empty!";throw console.error(i),i}if(!_.isString(t)||!t){var n="ERROR: WfsConnection stored query ID must be a string and not empty!";throw console.error(n),n}this.connectionUrl=e,this.storedQueryId=t}},M=function(){this.connectionUrl=void 0,this.storedQueryId=void 0,v.call(this)},v=function(){this.cache.clearCache()},y=function(e){if(!e){var t="ERROR: Options object is mandatory!";throw console.error(t),t}if(e.sites)d.call(this,e);else{if(!e.bbox){var i="ERROR: Either sites or bbox is mandatory in options!";throw console.error(i),i}m.call(this,e)}},O=function(){var e=this,t={connectionInstance:e,connectionUrl:void 0,storedQueryId:void 0,cache:new fi.fmi.metoclient.metolib.SplitterCache({sideFetchAfterFactor:1,sideFetchBeforeFactor:.5,maxBlockDataPoints:200,maxCacheDataSize:4e3})};t.cache.addDataProvider(u,function(e,i){s(t,e,i)}),this.getUrl=function(){return p.call(t)},this.getStoredQueryId=function(){return R.call(t)},this.connect=function(e,i){return E.call(t,T,void 0,e,i)},this.disconnect=function(){return E.call(t,M,void 0)},this.resetCache=function(){return E.call(t,v,void 0)},this.getData=function(e){return E.call(t,y,e?e.callback:void 0,e)}};return O}();