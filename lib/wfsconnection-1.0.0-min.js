"use strict";if("undefined"==typeof jQuery||!jQuery)throw"ERROR: jQuery is required for fi.fmi.metoclient.metolib.WfsConnection!";if("undefined"==typeof _||!_)throw"ERROR: Underscore is required for fi.fmi.metoclient.metolib.WfsConnection!";if("undefined"==typeof async||!async)throw"ERROR: Async is required for fi.fmi.metoclient.metolib.WfsConnection!";var fi=fi||{};if(fi.fmi=fi.fmi||{},fi.fmi.metoclient=fi.fmi.metoclient||{},fi.fmi.metoclient.metolib=fi.fmi.metoclient.metolib||{},!fi.fmi.metoclient.metolib.Utils)throw"ERROR: fi.fmi.metoclient.metolib.Utils is required for fi.fmi.metoclient.metolib.WfsConnection!";if(!fi.fmi.metoclient.metolib.SplitterCache)throw"ERROR: fi.fmi.metoclient.metolib.SplitterCache is required for fi.fmi.metoclient.metolib.WfsConnection!";if(!fi.fmi.metoclient.metolib.WfsRequestParser)throw"ERROR: fi.fmi.metoclient.metolib.WfsRequestParser is required for fi.fmi.metoclient.metolib.WfsConnection!";fi.fmi.metoclient.metolib.WfsConnection=function(){function a(a){return jQuery.trim(a).replace(/,\s+/,k)}function b(b){var c=[];if(_.isString(b))c.push(a(b));else if(_.isArray(b))for(var d=0;d<b.length;++d){var e=b[d];e&&c.push(a(e))}return c}function c(a,b,c){var d=c;if(a&&a.location&&b&&c){var e=c+l,f=b.indexOf(e);0===f&&(b=jQuery.trim(b.slice(e.length)));for(var g=b+k+c,h=0;h<a.location.length;++h){var i=a.location[h];if(-1!==i.indexOf(k)&&i===g){d=i;break}}}return d}function d(a,b){if(_.isArray(a)&&b&&b>0)for(var c=1;c<a.length;++c){var d=a[c-1],e=a[c];if(_.isObject(e)){var f=_.isObject(d)?d.time:void 0,g=e.time;void 0!==f&&null!==f&&void 0!==g&&null!==g&&g-f>b&&(g=f+b,a.splice(c,0,{time:g,value:0/0})),f=g}}}function e(a,b){return _.find(a,function(a){return _.isEqual(a,b)})}function f(a){var b=[];if(_.isArray(a))for(var c=0;c<a.length;++c){var d=a[c],f=_.isObject(d)&&(d.errorCode||d.errorText);if(_.isObject(d)&&_.isArray(d.error)&&d.error.length>0)for(var g=d.error,h=0;h<g.length;++h){var i=g[h];if(_.isObject(i)&&(i.errorCode||i.errorText)){var j={errorCode:i.errorCode,errorText:i.errorText,extension:d};e(b,j)||b.push(j)}else f=!0}else f=!0;if(f){var k={errorCode:_.isObject(d)?d.errorCode:void 0,errorText:_.isObject(d)&&_.isString(d.errorText)?d.errorText:m,extension:d};e(b,k)||b.push(k)}}return b}function g(a,b,e){var f={data:b?{}:void 0,errors:e};return b&&_.each(b.locations,function(e){var g=c(a,e.info.name,e.info.region);f.data[g]||(f.data[g]={}),_.each(e.data,function(c,h){f.data[g][h]||(f.data[g][h]=[]),d(c.timeValuePairs,a.resolution),_.each(c.timeValuePairs,function(a){var d={info:b.info,properties:b.properties,locationInfo:e.info,blockProperty:c.property,timeValuePair:a};f.data[g][h].push(d)})})}),f}function h(a,b,c){var d={data:b?{info:void 0,properties:void 0,locations:[]}:void 0,errors:f(c)};return b&&_.each(b.data,function(a){var b={info:void 0,data:{}};_.each(a,function(a,c){var e={property:void 0,timeValuePairs:[]};_.each(a,function(a){a&&(d.data.info||(d.data.info=a.info),d.data.properties||(d.data.properties=a.properties),e.property||(e.property=a.blockProperty),b.info||(b.info=a.locationInfo),e.timeValuePairs.push(a.timeValuePair))}),b.data[c]=e}),d.data.locations.push(b)}),d}function i(a,b,c){fi.fmi.metoclient.metolib.WfsRequestParser.getData({url:a.connectionUrl,storedQueryId:a.storedQueryId,requestParameter:b.parameter,begin:b.start,end:b.end,timestep:b.resolution,denyTimeAdjusting:!0,sites:b.location,callback:function(d,e){var f=g.call(a,b,d,e);c(f.errors,f.data)}})}var j="parserSites",k=",",l=" ",m="ERROR: Cache found error(s)!",n=function(a){if(a.timestep&&1!==a.timestep){var c=a.begin,d=a.end,e=a.timestep;a.denyTimeAdjusting||(c=fi.fmi.metoclient.metolib.WfsRequestParser.adjustBeginTime(e,c),d=fi.fmi.metoclient.metolib.WfsRequestParser.adjustEndTime(e,d,c));var f={service:j,parameter:_.isString(a.requestParameter)?a.requestParameter.split(k):a.requestParameter,start:c instanceof Date?c.getTime():c,end:d instanceof Date?d.getTime():d,resolution:e,location:b(a.sites)};this.cache.fetch(f,function(b,c){var d=h(f,c,b);a.callback(d.data,d.errors)},a.progressCallback)}else{var g=this;fi.fmi.metoclient.metolib.WfsRequestParser.getData({url:g.connectionUrl,storedQueryId:g.storedQueryId,requestParameter:a.requestParameter,begin:a.begin,end:a.end,timestep:a.timestep,denyTimeAdjusting:a.denyTimeAdjusting,sites:b(a.sites),callback:a.callback})}},o=function(a){var b=this;fi.fmi.metoclient.metolib.WfsRequestParser.getData({url:b.connectionUrl,storedQueryId:b.storedQueryId,requestParameter:a.requestParameter,begin:a.begin,end:a.end,timestep:a.timestep,denyTimeAdjusting:a.denyTimeAdjusting,bbox:a.bbox,callback:a.callback})},p=function(a,b){var c=!0;try{var d=Array.prototype.slice.call(arguments);d.shift(),d.shift(),a.apply(this,d)}catch(e){var f="ERROR: API level error occurred in a synchronous flow!";if(console.error(f),c=!1,b){var g={errorText:f};b(void 0,g)}}return c},q=function(){return this.connectionUrl},r=function(){return this.storedQueryId},s=function(a,b){if(!this.connectionUrl){if(!_.isString(a)||!a){var c="ERROR: WfsConnection URL must be a string and not empty!";throw console.error(c),c}if(!_.isString(b)||!b){var d="ERROR: WfsConnection stored query ID must be a string and not empty!";throw console.error(d),d}this.connectionUrl=a,this.storedQueryId=b}},t=function(){this.connectionUrl=void 0,this.storedQueryId=void 0,u.call(this)},u=function(){this.cache.clearCache()},v=function(a){if(!a){var b="ERROR: Options object is mandatory!";throw console.error(b),b}if(a.sites)n.call(this,a);else{if(!a.bbox){var c="ERROR: Either sites or bbox is mandatory in options!";throw console.error(c),c}o.call(this,a)}},w=function(){var a=this,b={connectionInstance:a,connectionUrl:void 0,storedQueryId:void 0,cache:new fi.fmi.metoclient.metolib.SplitterCache({sideFetchAfterFactor:1,sideFetchBeforeFactor:.5,maxBlockDataPoints:200,maxCacheDataSize:4e3})};b.cache.addDataProvider(j,function(a,c){i(b,a,c)}),this.getUrl=function(){return q.call(b)},this.getStoredQueryId=function(){return r.call(b)},this.connect=function(a,c){return p.call(b,s,void 0,a,c)},this.disconnect=function(){return p.call(b,t,void 0)},this.resetCache=function(){return p.call(b,u,void 0)},this.getData=function(a){return p.call(b,v,a?a.callback:void 0,a)}};return w}();