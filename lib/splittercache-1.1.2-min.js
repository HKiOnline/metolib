"use strict";if("undefined"==typeof _||!_)throw"ERROR: Underscore is required for fi.fmi.metoclient.metolib.SplitterCache!";if("undefined"==typeof async||!async)throw"ERROR: Async is required for fi.fmi.metoclient.metolib.SplitterCache!";var fi=fi||{};fi.fmi=fi.fmi||{},fi.fmi.metoclient=fi.fmi.metoclient||{},fi.fmi.metoclient.metolib=fi.fmi.metoclient.metolib||{},fi.fmi.metoclient.metolib.SplitterCache=function(){var a=function(a){var b,c=0;if(!_.isObject(a))throw"taskdef must be an object";if(!_.isString(a.service))throw"taskDef must contain a 'service' property of string type";if(!_.isArray(a.location)){if(!_.isString(a.location))throw"taskDef must contain a 'location' property of either an array or a string type";b=a.location,a.location=[],a.location.push(b)}if(!_.isArray(a.parameter)){if(!_.isString(a.parameter))throw"taskDef must contain a 'parameter' property of either an array or a string type";b=a.parameter,a.parameter=[],a.parameter.push(b)}if(!_.isNumber(a.resolution))throw"taskDef must contain a 'resolution' property of numeric type";if(!(a.resolution>.5))throw"taskDef.resolution must be a positive integer";if(a.resolution=Math.round(a.resolution),!_.isNumber(a.start))throw"taskDef must contain a 'start' property of numeric type";if(_.isNumber(a.pointCount)){if(!(a.pointCount>0))throw"taskDef.pointCount must be greater than zero";a.end=a.start+(a.pointCount-1)*a.resolution}else{if(!_.isNumber(a.end))throw"taskDef must contain either 'end' or 'pointCount' property of numeric type";if(a.end<a.start)throw"'end' must be greater than or equal to 'start'";c=(a.end-a.start)%a.resolution,0!==c&&(a.end=a.end+(a.resolution-c)),a.pointCount=(a.end-a.start)/a.resolution+1}},b=function(a,b){var c=0;if(_.isArray(a)&&_.isArray(b)){if(a.length===b.length){for(c=0;c<a.length;c++)if(-1===_.indexOf(b,a[c]))return!1;return!0}return!1}return void 0===a||null===a||void 0===b||null===b?!1:a===b},c=function(){var b=0,c=function(c){function d(){f=null,g=null,h=null,i=null,j=0,k=!1,l=!1,m=!1,n=!1,o=!1,p=!1,q=[]}var e=null,f=null,g=null,h=null,i=null,j=0,k=!1,l=!1,m=!1,n=!1,o=!1,p=!1,q=[],r=c,s=this;this.getId=function(){return e},this.getTaskDef=function(){return i},this.getStart=function(){return null!==i?i.start:void 0},this.getEnd=function(){return null!==i?i.end:void 0},this.getPointCount=function(){return null!==i?i.pointCount:void 0},this.getResolution=function(){return null!==i?i.resolution:void 0},this.getService=function(){return null!==i?i.service:void 0},this.getLocation=function(){return null!==i?i.location:void 0},this.getParameter=function(){return null!==i?i.parameter:void 0},this.getDataSize=function(){return null!==i?i.pointCount*i.parameter.length*i.location.length:0},this.pin=function(){return n?!1:(m||(m=!0,r&&r("blockPinned",s)),!0)},this.unpin=function(){m&&(m=!1,r&&r("blockUnpinned",s))},this.isPinned=function(){return m},this.isWaitingRecycling=function(){return n},this.isWaitingMerging=function(){return o},this.isFetched=function(){return l},this.setFetched=function(a){l=a===!0?a:!1},this.isFetching=function(){return k},this.setFetching=function(a){k=a===!0?a:!1},this.increaseNotUsed=function(){j++,r&&r("blockAged",s)},this.getNotUsedSince=function(){return j},this.markForRecycling=function(){n=!0,r&&r("blockEvicted",s)},this.markForMerging=function(){o=!0,r&&r("blockMarkedForMerge",s)},this.setData=function(a){h=a},this.getFetcher=function(){return g},this.recycle=function(){d(),r&&r("blockRecycled",s)},this.prepare=function(b,c){if(!_.isFunction(c))throw"fetcher must be a function";a(b),d(),i=b,g=c,p=!0,r&&r("blockPrepared",s)},this.getDataAsync=function(a){var b=this;if(!p)throw"Cannot getData in unprepared state, call prepare first";j=0,l?_.isFunction(a)?(_.defer(function(c,d){r&&r("blockCacheFetchFinished",s),a(c,d),b.unpin()},f,h),r&&r("blockCacheFetchStarted",s)):b.unpin():(void 0!==a&&_.isFunction(a)&&q.push(a),k||(k=!0,g(i,function(a,c){a&&(f=a),h=c,l=!0,async.whilst(function(){return q.length>0},function(a){try{if(l){var c=q.pop();c.call(b,f,h)}}catch(d){"undefined"!=typeof console&&console&&console.error("Error in block finished callback:"+d.message)}finally{a()}},function(){k=!1,b.unpin()}),r&&r("blockProviderFetchFinished",s)}),r&&r("blockProviderFetchStarted",s)))},e="id#"+b++,r&&r("blockCreated",s)};return c}(),d=0,e=0,f=function(f){function g(a,b){void 0!==N[a]&&_.each(N[a],function(a){try{a.call(M,b)}catch(c){}})}function h(a,b){var c=null;if(void 0===N[a])throw"Unknown event '"+a+"', use one of "+_.reduce(_.keys(N),function(a,b,c){return c>0&&(a+=", "),a+=b});if(!_.isFunction(b))throw"Event listener callback is not a function";return c="id"+d++,N[a][c]=b,c}function i(a,b){if(void 0===N[a])throw"Unknown event '"+a+"', use one of "+_.reduce(_.keys(N),function(a,b,c){c>0&&(a+=", "),a+=b});void 0!==N[a][b]&&delete N[a][b]}function j(a){async.each(a,function(a,b){a.markForRecycling(),b()},function(a){a&&"undefined"!=typeof console&&console&&console.error(a)})}function k(a,b,c){var d=null,e={},f=[];a.pin()&&b.pin()?(a.markForMerging(),b.markForMerging(),d=n(),e=_.clone(a.getTaskDef()),e.end=b.getEnd(),e.pointCount=a.getPointCount()+b.getPointCount(),d.prepare(e,a.getFetcher()),d.setFetching(!0),g("blockCacheFetchStarted",d),async.parallel({data1:function(b){a.getDataAsync(function(c,d){c?(v(f,0/0,e.location,e.parameter,0,0,a.getPointCount(),b),"undefined"!=typeof console&&console&&console.log("Error in merge:"+c)):v(f,d,e.location,e.parameter,0,0,a.getPointCount(),b)})},data2:function(c){b.getDataAsync(function(d,g){d?(v(f,0/0,e.location,e.parameter,a.getPointCount(),0,b.getPointCount(),c),"undefined"!=typeof console&&console&&console.log("Error in merge:"+d)):v(f,g,e.location,e.parameter,a.getPointCount(),0,b.getPointCount(),c)})}},function(){a.markForRecycling(),b.markForRecycling(),d.setData(f),d.setFetching(!1),d.setFetched(!0),g("blockCacheFetchFinished",d),c(null,d)})):(a.unpin(),b.unpin(),_.defer(function(){c("One or both blocks already marked for recycling",null)}))}function l(a,b){return a.getResolution()===b.getResolution()&&b.getStart()===a.getEnd()+a.getResolution()?!0:!1}function m(a,b){return!a.isWaitingMerging()&&!b.isWaitingMerging()&&(a.getPointCount()<G||b.getPointCount()<G)&&l(a,b)&&a.getPointCount()+b.getPointCount()<F?!0:!1}function n(){var a;return a=z.length>0?z.pop():new c(g)}function o(a,b,c,d){var e=!1;return a===c&&b===d?e=!0:d>=a&&b>c&&(e=!0),e}function p(a,b,c,d,e){var f=null;return(null===a||a<b-e.resolution)&&b>c&&(f=b>=d?null===a?u(e,c,d):u(e,Math.max(a,c),d):null===a?u(e,c,b-e.resolution):u(e,Math.max(a+e.resolution,c),b-e.resolution)),f}function q(a){a.isPinned()?async.whilst(function(){return a.isPinned()},function(a){setTimeout(a,500)},function(){a.recycle(),z.push(a)}):(a.recycle(),z.push(a))}function r(){_.each(A,function(a){a.isWaitingRecycling()&&q(a)})}function s(a){return a.getStart()}function t(a){var c=[],d=a.start,e=a.end,f=Math.ceil(D*a.pointCount),h=Math.ceil(E*a.pointCount),i=d-f*a.resolution,l=e+h*a.resolution,n=[],r=[],t=-1,v=null,w=null;for(J=0;B.length>0;)v=B.shift(),t=_.sortedIndex(A,v,s),A.splice(t,0,v);return A.length>0&&_.each(A,function(d,e){var f=!1,g=null,h=null,j=null,s=d.getStart(),t=d.getEnd();if(d.isWaitingRecycling())return q(d),void 0;a.service===d.getService()&&b(a.location,d.getLocation())&&b(a.parameter,d.getParameter())?(null!==w&&(j=w.getEnd()),g=p(j,s,i,l,a),null!==g&&g.length>0&&(Array.prototype.push.apply(r,g),async.reduce(g,L,function(a,b,c){c(null,a+b.getDataSize())},function(a,b){L=b}),Array.prototype.push.apply(c,g)),f=o(s,t,i,l),f?d.pin()?(c.push(d),K+=d.getDataSize()):"undefined"!=typeof console&&console&&console.error("Strange, unable to pin block!"):d.increaseNotUsed(),r.push(d),null!==w&&m(w,d)&&k(w,d,function(a,b){a?"undefined"!=typeof console&&console&&console.error(a):B.push(b)}),w=d):(d.increaseNotUsed(),r.push(d)),e===A.length-1&&null!==w&&w.getEnd()+a.resolution<l&&(h=u(a,Math.max(t+a.resolution,i),l),Array.prototype.push.apply(r,h),async.reduce(h,L,function(a,b,c){c(null,a+b.getDataSize())},function(a,b){L=b}),Array.prototype.push.apply(c,h));var v=_.sortedIndex(n,d,function(a){return a.getNotUsedSince()});n.splice(v,0,d),J+=d.getDataSize()}),0===c.length&&(c=u(a,i,l),Array.prototype.push.apply(r,c),async.reduce(c,L,function(a,b,c){c(null,a+b.getDataSize())},function(a,b){L=b})),A=[],A=r,r=[],async.whilst(function(){return 1.01*J>H},function(){var a=1.01*J-H;g("evictStarted",{inCache:J,toEvict:a});for(var b=[],c=null,d=0;a>d&&n.length>0;)c=n.pop(),void 0!==c&&(d+=c.getDataSize(),b.push(c));b.length>0&&(j(b),J-=d,g("evictFinished",{inCache:J,evicted:d}))},function(){}),c}function u(a,b,c){var d,e=[],f=Math.round((c-b)/a.resolution)+1,g=Math.ceil(f/F),h=0,i=null;for(h=0;g>h;h++)i=n(),d=_.clone(a),d.start=b+h*a.resolution*F,d.pointCount=Math.min(F,f-h*F),d.end=d.start+(d.pointCount-1)*a.resolution,i.prepare(d,x(a.service)),i.pin()?e.push(i):"undefined"!=typeof console&&console&&console.error("Strange, unable to pin block!");return e}function v(a,b,c,d,e,f,g,h){var i=_.isObject(b),j=0,k=0,l=0;async.each(c,function(c,h){void 0===a[c]&&(a[c]={}),async.each(d,function(d,h){var m=!1;if(void 0===a[c][d]&&(a[c][d]=[]),i&&(_.isObject(b[c])&&_.isArray(b[c][d])?b[c][d].length<f+g&&(m=!0,"undefined"!=typeof console&&console&&console.error("The service returned "+b[c][d].length+" values for location "+c+" and parameter "+d+" when "+(f+g)+" were requested. Filling the whole segment with NaN")):m=!0),m)for(j=e,l=e+g;l>j;)a[c][d][j++]=0/0;else if(i)for(j=e,k=f,l=e+g;l>j;)a[c][d][j++]=b[c][d][k++];else for(j=e,l=e+g;l>j;)a[c][d][j++]=b;h()},function(){h()})},function(){h()})}function w(a,b,c){var d={},e=null,f=!1;if(!_.isFunction(b))throw"finishCallback must be a function";if(_.isFunction(c)&&(f=!0),null===x(a.service))throw"No data fetcher set for service '"+a.service+"', unable to provide data";void 0!==C[a.service]&&(C[a.service].resolution!==a.resolution||0!==Math.abs(C[a.service].start-a.start)%a.resolution)&&y(a.service),C[a.service]={start:a.start,resolution:a.resolution};var h=t(a);d.steps=_.range(a.start,a.end+a.resolution,a.resolution),d.data={},async.each(h,function(b,g){var h=b.getTaskDef(),i=0/0,j=0/0,k=0/0,l=0/0,m=0/0,n=0/0;return o(h.start,h.end,a.start,a.end)?(h.start<a.start?(i=a.start,m=Math.round((a.start-h.start)/a.resolution)):(i=h.start,m=0),k=_.indexOf(d.steps,i,!0),h.end>a.end?(j=a.end,l=d.steps.length-1):(j=h.end,l=_.indexOf(d.steps,h.end,!0)),n=l-k+1,b.getDataAsync(function(a,b){var l=b;a&&(null===e&&(e=[]),e.push({start:h.start,end:h.end,error:a}),b||(l=0/0)),v(d.data,l,h.location,h.parameter,k,m,n,function(){f&&c(a,i,j),g()})}),void 0):(b.getDataAsync(),g(),void 0)},function(){b(e,d),g("fetchFinished",a)})}function x(a){return void 0!==I[a]?(I[a].nextIndex=(I[a].nextIndex+1)%I[a].providers.length,I[a].providers[I[a].nextIndex].cb):null}function y(a){_.each(A,function(b){(void 0===a||b.getService()===a)&&b.markForRecycling()}),g("cacheCleared",a)}var z=[],A=[],B=[],C=[],D=.5,E=1,F=500,G=20,H=5e4,I={},J=0,K=0,L=0,M=this,N={blockCreated:{},blockPrepared:{},blockProviderFetchStarted:{},blockProviderFetchFinished:{},blockCacheFetchStarted:{},blockCacheFetchFinished:{},blockPinned:{},blockUnpinned:{},blockEvicted:{},blockRecycled:{},blockAged:{},blockMarkedForMerge:{},evictStarted:{},evictFinished:{},fetchStarted:{},fetchFinished:{},cacheCleared:{},dataProviderAdded:{},dataProviderRemoved:{}};this.addDataProvider=function(a,b){var c={};if(!_.isFunction(b))throw"Fetcher must be a function";return void 0===I[a]&&(I[a]={nextIndex:0,providers:[]}),c.id="id#"+e++,c.cb=b,I[a].providers.push(c),g("dataProviderAdded",{service:a,providerId:c.id}),c.id},this.removeDataProvider=function(a,b){var c=0,d=!1;void 0!==I[a]&&(c=I[a].providers.length,I[a].providers=_.reject(I[a].providers,function(a){return a.id===b}),0===I[a].providers.length?(delete I.service,d=!0):c!==I[a].providers.length&&(d=!0),d&&g("dataProviderRemoved",{service:a,providerId:b}))},this.clearCache=function(){y(),r(),C=[],K=0,L=0},this.fetch=function(b,c,d){a(b),g("fetchStarted",b),w(b,c,d)},this.getCachedItemCount=function(){return J},this.getFillingDegree=function(){return J/H},this.getHitRatio=function(){return K/(K+L)},this.addListener=function(a,b){return h(a,b)},this.removeListener=function(a,b){return i(a,b)},void 0!==f.sideFetchBeforeFactor&&_.isNumber(f.sideFetchBeforeFactor)&&f.sideFetchBeforeFactor>=0&&(D=f.sideFetchBeforeFactor),void 0!==f.sideFetchAfterFactor&&_.isNumber(f.sideFetchAfterFactor)&&f.sideFetchAfterFactor>=0&&(E=f.sideFetchAfterFactor),void 0!==f.maxBlockDataPoints&&_.isNumber(f.maxBlockDataPoints)&&f.maxBlockDataPoints>0&&(F=f.maxBlockDataPoints),void 0!==f.minBlockDataPoints&&_.isNumber(f.minBlockDataPoints)&&(G=f.minBlockDataPoints>0&&f.minBlockDataPoints<F?f.minBlockDataPoints:0),G>F&&(G=F),void 0!==f.maxCacheDataSize&&_.isNumber(f.maxCacheDataSize)&&f.maxCacheDataSize>0&&(H=f.maxCacheDataSize)};return f}();