"use strict";if("undefined"==typeof _||!_)throw"ERROR: Underscore is required for fi.fmi.metoclient.metolib.Utils!";var fi=fi||{};if(fi.fmi=fi.fmi||{},fi.fmi.metoclient=fi.fmi.metoclient||{},fi.fmi.metoclient.metolib=fi.fmi.metoclient.metolib||{},fi.fmi.metoclient.metolib.Utils=function(){function e(e){var t=0;if(e)if(_.isFunction(Object.keys))t=Object.keys(e).length;else for(var i in e)e.hasOwnProperty(i)&&++t;return t}return function(){if(!jQuery.browser){var e,t;jQuery.uaMatch=function(e){e=e.toLowerCase();var t=/(chrome)[ \/]([\w.]+)/.exec(e)||/(webkit)[ \/]([\w.]+)/.exec(e)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(e)||/(msie) ([\w.]+)/.exec(e)||0>e.indexOf("compatible")&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(e)||[];return{browser:t[1]||"",version:t[2]||"0"}},e=jQuery.uaMatch(navigator.userAgent),t={},e.browser&&(t[e.browser]=!0,t.version=e.version),t.chrome?t.webkit=!0:t.webkit&&(t.safari=!0),jQuery.browser=t}}(),function(){Date.prototype.toISOString||(Date.prototype.toJSON||(Date.prototype.toJSON=function(){var e=function(e){return 10>e?"0"+e:e};return this.getUTCFullYear()+"-"+e(this.getUTCMonth()+1)+"-"+e(this.getUTCDate())+"T"+e(this.getUTCHours())+":"+e(this.getUTCMinutes())+":"+e(this.getUTCSeconds())+"Z"}),Date.prototype.toISOString=Date.prototype.toJSON)}(),{objectLength:function(t){return e(t)},encodeUriComponent:function(e){return e?encodeURIComponent(e):e},encodeUri:function(e){return e?encodeURI(e):e},sortStringArray:function(e,t){var i;return e&&_.isArray(e)&&(t?(i=[],_.each(e,function(e){i.push(e)})):i=e,i.sort(function(e,t){var i=0,n=e.toLowerCase(),r=t.toLowerCase();return r>n?i=-1:n>r&&(i=1),i})),i}}}(),"undefined"==typeof jQuery||!jQuery)throw"ERROR: jQuery is required for fi.fmi.metoclient.metolib.WfsRequestParser!";if("undefined"==typeof _||!_)throw"ERROR: Underscore is required for fi.fmi.metoclient.metolib.WfsRequestParser!";var fi=fi||{};if(fi.fmi=fi.fmi||{},fi.fmi.metoclient=fi.fmi.metoclient||{},fi.fmi.metoclient.metolib=fi.fmi.metoclient.metolib||{},fi.fmi.metoclient.metolib.Utils===void 0||!fi.fmi.metoclient.metolib.Utils)throw"ERROR: fi.fmi.metoclient.metolib.Utils is required for fi.fmi.metoclient.metolib.WfsRequestParser!";if(fi.fmi.metoclient.metolib.WfsRequestParser=function(){function e(e,i,r){try{var o={info:{begin:void 0,end:void 0},locations:[],positions:{},gmlcovPositions:{srsDimension:void 0,timeIndex:void 0,contents:[]},data:[],parameters:[],properties:{}},a=0,c=function(){++a},s=function(){a>0&&--a,0===a&&(a=-1,it(r,t(o,i),i))};n(e,o,c,s,i),0===a&&s()}catch(u){console.error("ERROR: Error during synchronous data parsing flow!"),a=-1;var l={};l[ft.KEY_ERROR_TEXT]=""+u,i.push(l),it(r,void 0,i)}}function t(e,t){var n={info:e.info,parameters:e.parameters,properties:e.properties,locations:[]};try{var r=e.gmlcovPositions.srsDimension||0,o=e.gmlcovPositions.contents||[],a=e.parameters.length;if(r>0&&e.data.length===a*(o.length/r)&&e.locations.length===fi.fmi.metoclient.metolib.Utils.objectLength(e.positions)){for(var c=0;e.locations.length>c;++c){var s=e.locations[c],u=s.pointRef,l="ERROR: Location and position data do not match!";if(!u)throw l;var f=e.positions[u];if(!f)throw l;n.locations.push({info:{id:s.id||s.geoid||"",wmo:s.wmo||"",name:s.name||f.name||"",region:s.region||"",country:s.country||"",timezone:s.timezone||"",position:f.position||""}})}for(var _=0;o.length>_;_+=r){for(var h={time:parseInt(o[_+r-1],10)*ft.EPOCH_TO_MS,values:{}},d=0;n.parameters.length>d;++d){var m=n.parameters[d];m&&(h.values[m]=parseFloat(e.data[_/r*a+d]),n.properties[m]||(console.error("ERROR: Server has not provided properties for request parameter!"),n.properties[m]=ft.PROPERTY_OBJECT_EMPTY))}for(var E=0;n.locations.length>E;++E){for(var p=0,R=n.locations[E],T=0;R.info.position.length>T&&R.info.position[T]===o[_+T];++T)++p;if(R.info.position&&p===R.info.position.length){R.timeValuePairs||(R.timeValuePairs=[]),R.timeValuePairs.push(h);break}}}i(n.locations)}else if(0!==e.data.length||0!==o.length)throw"ERROR: Parsed lists do not match!"}catch(v){console.error("ERROR: Could not finalize data!"),n=void 0;var M={};M[ft.KEY_ERROR_TEXT]=""+v,t.push(M)}return n}function i(e){if(e&&e.length)for(var t=0;e.length-1>t;++t){for(var i=e[t],n=[],r=t+1;e.length>r;++r){var o=e[r];if(i.info.position.length===o.info.position.length){for(var a=i.info.position.length,c=!0,s=0;a>s;++s)if(i.info.position[s]!==o.info.position[s]){c=!1;break}c&&n.push(o)}}if(n.length)for(var u=i.timeValuePairs,l=u.length/(n.length+1),f=0;n.length>f;++f)n[f].timeValuePairs=u.splice(l,l)}}function n(e,t,i,n,o){e&&(B(e,o)||jQuery(e).children(ft.XML_WFS_FEATURE_COLLECTION).each(function(){r(this,t,i,n,o)}))}function r(e,t,i,n,r){jQuery(e).children(ft.XML_WFS_MEMBER).each(function(){o(this,t,i,n,r),a(this,t,i,n,r)})}function o(e,t,i,n,r){jQuery(e).children(ft.XML_OMSO_POINT_TIME_SERIES_OBSERVATION).each(function(){c(this,t.info,i,n,r),f(this,t.properties,i,n,r),h(this,t,i,n,r),X(this,t,i,n,r)})}function a(e,t,i,n,r){jQuery(e).children(ft.XML_OMSO_GRID_SERIES_OBSERVATION).each(function(){c(this,t.info,i,n,r),f(this,t.properties,i,n,r),h(this,t,i,n,r),X(this,t,i,n,r)})}function c(e,t,i,n,r){jQuery(e).children(ft.XML_OM_PHENOMENON_TIME).each(function(){s(this,t,i,n,r)})}function s(e,t,i,n,r){jQuery(e).children(ft.XML_GML_TIME_PERIOD).each(function(){u(this,t,i,n,r),l(this,t,i,n,r)})}function u(e,t){jQuery(e).children(ft.XML_GML_BEGIN_POSITION).each(function(){var e=jQuery.trim(jQuery(this).text());e&&(t.begin=new Date(e))})}function l(e,t){jQuery(e).children(ft.XML_GML_END_POSITION).each(function(){var e=jQuery.trim(jQuery(this).text());e&&(t.end=new Date(e))})}function f(e,t,i,n,r){jQuery(e).children(ft.XML_OM_OBSERVED_PROPERTY).each(function(){var e=jQuery.trim(jQuery(this).attr(ft.XML_ATTR_XLINK_HREF));e&&(nt(e,r,function(e){B(e,r)||e&&(W(e,t,i,n,r),z(e,t,i,n,r)),n()}),i())})}function h(e,t,i,n,r){jQuery(e).children(ft.XML_OM_FEATURE_OF_INTEREST).each(function(){d(this,t,i,n,r)})}function d(e,t,i,n,r){jQuery(e).children(ft.XML_SAMS_SF_SPATIAL_SAMPLING_FEATURE).each(function(){m(this,t.locations,i,n,r),g(this,t.positions,i,n,r)})}function m(e,t,i,n,r){jQuery(e).children(ft.XML_SAM_SAMPLED_FEATURE).each(function(){E(this,t,i,n,r)})}function E(e,t,i,n,r){jQuery(e).children(ft.XML_TARGET_LOCATION_COLLECTION).each(function(){p(this,t,i,n,r)})}function p(e,t,i,n,r){jQuery(e).children(ft.XML_TARGET_MEMBER).each(function(){R(this,t,i,n,r)})}function R(e,t,i,n,r){jQuery(e).children(ft.XML_TARGET_LOCATION).each(function(){var e={};T(this,e,i,n,r),v(this,e,i,n,r),M(this,e,i,n,r),y(this,e,i,n,r),O(this,e,i,n,r),L(this,e,i,n,r),t.push(e)})}function T(e,t){jQuery(e).children(ft.XML_GML_IDENTIFIER).each(function(){t.id=jQuery.trim(jQuery(this).text())})}function v(e,t){jQuery(e).children(ft.XML_GML_NAME).each(function(){var e=jQuery.trim(jQuery(this).attr(ft.XML_ATTR_CODE_SPACE));ft.XML_ATTR_CODE_SPACE_NAME===e?t.name=jQuery.trim(jQuery(this).text()):ft.XML_ATTR_CODE_SPACE_WMO===e?t.wmo=jQuery.trim(jQuery(this).text()):ft.XML_ATTR_CODE_SPACE_GEOID===e&&(t.geoid=jQuery.trim(jQuery(this).text()))})}function M(e,t){jQuery(e).children(ft.XML_TARGET_REGION).each(function(){t.region=jQuery.trim(jQuery(this).text())})}function y(e,t){jQuery(e).children(ft.XML_TARGET_COUNTRY).each(function(){t.country=jQuery.trim(jQuery(this).text())})}function O(e,t){jQuery(e).children(ft.XML_TARGET_TIMEZONE).each(function(){t.timezone=jQuery.trim(jQuery(this).text())})}function L(e,t){jQuery(e).children(ft.XML_TARGET_REPRESENTATIVE_POINT).each(function(){t.pointRef=jQuery.trim(jQuery(this).attr(ft.XML_ATTR_XLINK_HREF)),t.pointRef&&t.pointRef.charAt(0)===ft.XML_REF_PREFIX&&(t.pointRef=t.pointRef.slice(1))})}function g(e,t,i,n,r){jQuery(e).children(ft.XML_SAMS_SHAPE).each(function(){P(this,t,i,n,r)})}function S(e,t,i,n,r){jQuery(e).children(ft.XML_GML_POINT).each(function(){var e=this,o=jQuery.trim(jQuery(e).attr(ft.XML_ATTR_GML_ID));if(o){t[o]||(t[o]={name:"",position:[]});var a=t[o];b(this,a,i,n,r),C(this,a.position,i,n,r)}})}function P(e,t,i,n,r){jQuery(e).children(ft.XML_GML_MULTI_POINT).each(function(){I(this,t,i,n,r),A(this,t,i,n,r)})}function I(e,t,i,n,r){jQuery(e).children(ft.XML_GML_POINT_MEMBER).each(function(){S(this,t,i,n,r)})}function A(e,t,i,n,r){jQuery(e).children(ft.XML_GML_POINT_MEMBERS).each(function(){S(this,t,i,n,r)})}function b(e,t){jQuery(e).children(ft.XML_GML_NAME).each(function(){t.name=jQuery.trim(jQuery(this).text())})}function C(e,t){jQuery(e).children(ft.XML_GML_POS).each(function(){var e=jQuery.trim(jQuery(this).text());e&&t.push.apply(t,e.split(ft.REGEX_WHITE_SPACE))})}function X(e,t,i,n,r){jQuery(e).children(ft.XML_OM_RESULT).each(function(){Q(this,t,i,n,r)})}function Q(e,t,i,n,r){jQuery(e).children(ft.XML_GMLCOV_MULTI_POINT_COVERAGE).each(function(){U(this,t,i,n,r),w(this,t,i,n,r),j(this,t,i,n,r)})}function j(e,t,i,n,r){jQuery(e).children(ft.XML_GMLCOV_RANGE_TYPE).each(function(){N(this,t,i,n,r)})}function N(e,t,i,n,r){jQuery(e).children(ft.XML_SWE_DATA_RECORD).each(function(){D(this,t.parameters,i,n,r)})}function D(e,t){jQuery(e).children(ft.XML_SWE_FIELD).each(function(){var e=jQuery.trim(jQuery(this).attr(ft.XML_ATTR_NAME));e&&t.push(e)})}function U(e,t,i,n,r){jQuery(e).children(ft.XML_GML_DOMAIN_SET).each(function(){F(this,t,i,n,r)})}function F(e,t,i,n,r){jQuery(e).children(ft.XML_GMLCOV_SIMPLE_MULTI_POINT).each(function(){var e=jQuery.trim(jQuery(this).attr(ft.XML_ATTR_SRS_DIMENSION));e&&(e=parseInt(e,10),e>0&&(t.gmlcovPositions.srsDimension=e,t.gmlcovPositions.timeIndex=e-1)),G(this,t.gmlcovPositions.contents,i,n,r)})}function G(e,t){jQuery(e).children(ft.XML_GMLCOV_POSITIONS).each(function(){var e=jQuery.trim(jQuery(this).text());e&&t.push.apply(t,e.split(ft.REGEX_WHITE_SPACE))})}function w(e,t,i,n,r){jQuery(e).children(ft.XML_GML_RANGE_SET).each(function(){x(this,t,i,n,r)})}function x(e,t,i,n,r){jQuery(e).children(ft.XML_GML_DATA_BLOCK).each(function(){k(this,t.data,i,n,r)})}function k(e,t){jQuery(e).children(ft.XML_GML_DOUBLE_OR_NIL_REASON_TUPLE_LIST).each(function(){var e=jQuery.trim(jQuery(this).text());e&&t.push.apply(t,e.split(ft.REGEX_WHITE_SPACE))})}function B(e,t){var i=!1;try{e&&jQuery(e).children(ft.XML_EXCEPTION_REPORT).each(function(){i=!0;var e={};t.push(e),q(this,e)})}catch(n){console.error("ERROR: Error while parsing exception data!");var r={};r[ft.KEY_ERROR_TEXT]=""+n,t.push(r)}return i}function q(e,t){jQuery(e).children(ft.XML_EXCEPTION).each(function(){t[ft.KEY_ERROR_CODE]=jQuery.trim(jQuery(this).attr(ft.XML_ATTR_EXCEPTION_CODE)),Y(this,t)})}function Y(e,t){jQuery(e).children(ft.XML_EXCEPTION_TEXT).each(function(){t[ft.KEY_ERROR_TEXT]=jQuery.trim(jQuery(this).text())})}function W(e,t,i,n,r){jQuery(e).children(ft.XML_COMPOSITE_OBSERVABLE_PROPERTY).each(function(){V(this,t,i,n,r)})}function V(e,t,i,n,r){jQuery(e).children(ft.XML_COMPONENT).each(function(){z(this,t,i,n,r)})}function z(e,t,i,n,r){jQuery(e).children(ft.XML_OBSERVABLE_PROPERTY).each(function(){var e=jQuery.trim(jQuery(this).attr(ft.XML_ATTR_GML_ID));if(e){var o=_.clone(ft.PROPERTY_OBJECT_EMPTY);H(this,o,i,n,r),K(this,o,i,n,r),J(this,o,i,n,r),Z(this,o,i,n,r),t[e]=o}})}function H(e,t){jQuery(e).children(ft.XML_LABEL).each(function(){t.label=jQuery.trim(jQuery(this).text())})}function K(e,t){jQuery(e).children(ft.XML_BASE_PHENOMENON).each(function(){t.phenomenon=jQuery.trim(jQuery(this).text())})}function J(e,t){jQuery(e).children(ft.XML_UOM).each(function(){t.unit=jQuery.trim(jQuery(this).attr(ft.XML_ATTR_UOM))})}function Z(e,t,i,n,r){jQuery(e).children(ft.XML_STATISTICAL_MEASURE).each(function(){$(this,t,i,n,r)})}function $(e,t,i,n,r){jQuery(e).children(ft.XML_STATISTICAL_MEASURE_INNER).each(function(){et(this,t,i,n,r),tt(this,t,i,n,r)})}function et(e,t){jQuery(e).children(ft.XML_STATISTICAL_FUNCTION).each(function(){t.statisticalFunction=jQuery.trim(jQuery(this).text())})}function tt(e,t){jQuery(e).children(ft.XML_AGGREGATION_TIME_PERIOD).each(function(){t.statisticalPeriod=jQuery.trim(jQuery(this).text())})}function it(e,t,i){try{e&&e(t,i)}catch(n){console.error("ERROR: Callback function error!")}}function nt(e,t,i){setTimeout(function(){jQuery.ajax({type:ft.HTTP_METHOD,url:e,dataType:ft.DATA_TYPE,success:function(e){it(i,e,t)},error:function(e,n,r){var o={};o[ft.KEY_ERROR_CODE]=e.status,o[ft.KEY_ERROR_TEXT]=r||n,t.push(o),it(i,void 0,t)}})},0)}function rt(t,i){var n=[];nt(t,n,function(t,n){e(t,n,i)})}function ot(e,t,i){if(e&&e.parameters&&t&&i)for(var n=0;e.parameters.length>n;++n){var r=e.parameters[n];if(r){for(var o={property:e.properties[r],timeValuePairs:[]},a=0;t.length>a;++a){var c=t[a];o.timeValuePairs.push({time:c.time,value:c.values[r]})}i[r]=o}}}function at(e,t,i){var n;try{if(t&&t.parameters&&t.properties&&(n={info:t.info,properties:t.properties,locations:[]},t.locations&&t.locations.length>0))for(var r=t.locations,o=0;r.length>o;++o){var a=r[o],c={info:a.info,data:{}};ot(t,a.timeValuePairs,c.data),n.locations.push(c)}}catch(s){var u="ERROR: Could not finalize data!";console.error(u),n=void 0;var l={};l[ft.KEY_ERROR_TEXT]=""+s,i.push(l)}e(n,i)}function ct(e,t,i,n,r,o,a,c,s,u,l,f){if(n instanceof Date||isNaN(n)||(n=new Date(n)),r instanceof Date||isNaN(r)||(r=new Date(r)),i&&_.isArray(i)&&(i=i.join()),(void 0===o||null===o)&&a&&a>0&&n instanceof Date&&r instanceof Date&&(o=Math.round((r.getTime()-n.getTime())/a)),!(e&&_.isString(e)&&t&&_.isString(t)&&i&&_.isString(i)&&n instanceof Date&&r instanceof Date&&n.getTime()<=r.getTime())||o&&!_.isNumber(o)||!s&&!u||s&&!_.isString(s)&&!_.isArray(s)||u&&!_.isString(u)||l&&!_.isString(l)){var h="ERROR: Wrong or missing information for the request!";throw console.error(h),h}c||(n.setTime(st(o,n).getTime()),r.setTime(ut(o,r,n).getTime()));var d=/\.\d+/;n=fi.fmi.metoclient.metolib.Utils.encodeUriComponent(n.toISOString()).split(d).join(""),r=fi.fmi.metoclient.metolib.Utils.encodeUriComponent(r.toISOString()).split(d).join("");var m="",E=Math.floor(o/ft.MIN_TO_MS);E&&E>0&&(m=ft.REQUEST_TIMESTEP+E),i=fi.fmi.metoclient.metolib.Utils.encodeUriComponent(i);var p="";if(s){_.isString(s)&&(s=[s]);for(var R=0;s.length>R;++R){var T=s[R];T&&(T=fi.fmi.metoclient.metolib.Utils.encodeUriComponent(T),p+=ft.REQUEST_PLACE+T)}}var v="";u&&(v=ft.REQUEST_BBOX+fi.fmi.metoclient.metolib.Utils.encodeUriComponent(u));var M="";l&&(M=ft.REQUEST_CRS+fi.fmi.metoclient.metolib.Utils.encodeUriComponent(l));var y=ft.REQUEST_STORED_QUERY_ID+fi.fmi.metoclient.metolib.Utils.encodeUriComponent(t),O=-1===e.indexOf(ft.URL_QUERY_PREFIX_BEGIN)?ft.URL_QUERY_PREFIX_BEGIN:ft.URL_QUERY_PREFIX_AND;e.length>0&&(e.indexOf(ft.URL_QUERY_PREFIX_BEGIN)===e.length-1||e.indexOf(ft.URL_QUERY_PREFIX_AND)===e.length-1)&&(O="");var L=e+O+ft.REQUEST_GET_FEATURE+y+ft.REQUEST_PARAMETERS+i+ft.REQUEST_BEGIN+n+ft.REQUEST_END+r+m+p+v+M;rt(L,f)}function st(e,t){var i;if(void 0!==t&&null!==t){i=t instanceof Date?new Date(t.getTime()):new Date(t),i.setMilliseconds(0),i.setSeconds(0);var n=e?Math.floor(e/ft.MIN_TO_MS):void 0;if(n){var r=i.getMinutes();r-=r%n,i.setMinutes(r)}}return i}function ut(e,t,i){var n;if(void 0!==i&&null!==i&&void 0!==t&&null!==t){n=t instanceof Date?new Date(t.getTime()):new Date(t);var r=st(e,i);if(e){var o=(n.getTime()-r.getTime())%e;o>0&&n.setTime(n.getTime()+(e-o))}}return n}function lt(e){if(!e||!e.callback){var t="ERROR: Options object and callback function in it are mandatory!";throw console.error(t),t}try{ct(e.url,e.storedQueryId,e.requestParameter,e.begin,e.end,e.timestep,e.numOfTimesteps,e.denyTimeAdjusting,e.sites,e.bbox,e.crs,function(t,i){at(e.callback,t,i)})}catch(i){setTimeout(function(){console.error("ERROR: Get data error!");var t={};t[ft.KEY_ERROR_TEXT]=""+i,it(e.callback,void 0,[t])},0)}}var ft={REGEX_WHITE_SPACE:/\s+/,EPOCH_TO_MS:1e3,MIN_TO_MS:6e4,HTTP_METHOD:"GET",DATA_TYPE:"xml",URL_QUERY_PREFIX_BEGIN:"?",URL_QUERY_PREFIX_AND:"&",REQUEST_GET_FEATURE:"request=getFeature",REQUEST_STORED_QUERY_ID:"&storedquery_id=",REQUEST_PARAMETERS:"&parameters=",REQUEST_BEGIN:"&starttime=",REQUEST_END:"&endtime=",REQUEST_TIMESTEP:"&timestep=",REQUEST_PLACE:"&place=",REQUEST_BBOX:"&bbox=",REQUEST_CRS:"&crs=",XML_WFS_FEATURE_COLLECTION:"wfs\\:FeatureCollection, FeatureCollection",XML_WFS_MEMBER:"wfs\\:member, member",XML_OMSO_POINT_TIME_SERIES_OBSERVATION:"omso\\:PointTimeSeriesObservation, PointTimeSeriesObservation",XML_OMSO_GRID_SERIES_OBSERVATION:"omso\\:GridSeriesObservation, GridSeriesObservation",XML_OM_PHENOMENON_TIME:"om\\:phenomenonTime, phenomenonTime",XML_GML_TIME_PERIOD:"gml\\:TimePeriod, TimePeriod",XML_GML_BEGIN_POSITION:"gml\\:beginPosition, beginPosition",XML_GML_END_POSITION:"gml\\:endPosition, endPosition",XML_OM_OBSERVED_PROPERTY:"om\\:observedProperty, observedProperty",XML_OM_FEATURE_OF_INTEREST:"om\\:featureOfInterest, featureOfInterest",XML_SAMS_SF_SPATIAL_SAMPLING_FEATURE:"sams\\:SF_SpatialSamplingFeature, SF_SpatialSamplingFeature",XML_SAM_SAMPLED_FEATURE:"sam\\:sampledFeature, sampledFeature",XML_TARGET_LOCATION_COLLECTION:"target\\:LocationCollection, LocationCollection",XML_TARGET_MEMBER:"target\\:member, member",XML_TARGET_LOCATION:"target\\:Location, Location",XML_GML_IDENTIFIER:"gml\\:identifier, identifier",XML_TARGET_REGION:"target\\:region, region",XML_TARGET_COUNTRY:"target\\:country, country",XML_TARGET_TIMEZONE:"target\\:timezone, timezone",XML_TARGET_REPRESENTATIVE_POINT:"target\\:representativePoint, representativePoint",XML_SAMS_SHAPE:"sams\\:shape, shape",XML_GML_MULTI_POINT:"gml\\:MultiPoint, MultiPoint",XML_GML_POINT_MEMBER:"gml\\:pointMember, pointMember",XML_GML_POINT_MEMBERS:"gml\\:pointMembers, pointMembers",XML_GML_POINT:"gml\\:Point, Point",XML_GML_NAME:"gml\\:name, name",XML_GML_POS:"gml\\:pos, pos",XML_OM_RESULT:"om\\:result, result",XML_GMLCOV_MULTI_POINT_COVERAGE:"gmlcov\\:MultiPointCoverage, MultiPointCoverage",XML_GML_DOMAIN_SET:"gml\\:domainSet, domainSet",XML_GMLCOV_SIMPLE_MULTI_POINT:"gmlcov\\:SimpleMultiPoint, SimpleMultiPoint",XML_GMLCOV_POSITIONS:"gmlcov\\:positions, positions",XML_GML_RANGE_SET:"gml\\:rangeSet, rangeSet",XML_GML_DATA_BLOCK:"gml\\:DataBlock, DataBlock",XML_GML_DOUBLE_OR_NIL_REASON_TUPLE_LIST:"gml\\:doubleOrNilReasonTupleList, doubleOrNilReasonTupleList",XML_GMLCOV_RANGE_TYPE:"gmlcov\\:rangeType, rangeType",XML_SWE_DATA_RECORD:"swe\\:DataRecord, DataRecord",XML_SWE_FIELD:"swe\\:field, field",XML_COMPOSITE_OBSERVABLE_PROPERTY:"CompositeObservableProperty",XML_COMPONENT:"component",XML_OBSERVABLE_PROPERTY:"ObservableProperty",XML_LABEL:"label",XML_BASE_PHENOMENON:"basePhenomenon",XML_UOM:"uom",XML_STATISTICAL_MEASURE:"statisticalMeasure",XML_STATISTICAL_MEASURE_INNER:"StatisticalMeasure",XML_STATISTICAL_FUNCTION:"statisticalFunction",XML_AGGREGATION_TIME_PERIOD:"aggregationTimePeriod",XML_ATTR_NAME:"name",XML_ATTR_SRS_DIMENSION:"srsDimension",XML_ATTR_XLINK_HREF:"xlink:href",XML_ATTR_GML_ID:"gml:id",XML_ATTR_CODE_SPACE:"codeSpace",XML_ATTR_CODE_SPACE_NAME:"http://xml.fmi.fi/namespace/locationcode/name",XML_ATTR_CODE_SPACE_WMO:"http://xml.fmi.fi/namespace/locationcode/wmo",XML_ATTR_CODE_SPACE_GEOID:"http://xml.fmi.fi/namespace/locationcode/geoid",XML_ATTR_UOM:"uom",XML_REF_PREFIX:"#",XML_EXCEPTION_REPORT:"ExceptionReport",XML_EXCEPTION:"Exception",XML_ATTR_EXCEPTION_CODE:"exceptionCode",XML_EXCEPTION_TEXT:"ExceptionText",KEY_ERROR_CODE:"errorCode",KEY_ERROR_TEXT:"errorText",PROPERTY_OBJECT_EMPTY:{label:"",unit:"",phenomenon:"",statisticalFunction:"",statisticalPeriod:""}};return{getData:lt,adjustBeginTime:st,adjustEndTime:ut}}(),"undefined"==typeof _||!_)throw"ERROR: Underscore is required for fi.fmi.metoclient.metolib.SplitterCache!";if("undefined"==typeof async||!async)throw"ERROR: Async is required for fi.fmi.metoclient.metolib.SplitterCache!";var fi=fi||{};if(fi.fmi=fi.fmi||{},fi.fmi.metoclient=fi.fmi.metoclient||{},fi.fmi.metoclient.metolib=fi.fmi.metoclient.metolib||{},fi.fmi.metoclient.metolib.SplitterCache=function(){var e=function(e){var t,i=0;if(!_.isObject(e))throw"taskdef must be an object";if(!_.isString(e.service))throw"taskDef must contain a 'service' property of string type";if(!_.isArray(e.location)){if(!_.isString(e.location))throw"taskDef must contain a 'location' property of either an array or a string type";t=e.location,e.location=[],e.location.push(t)}if(!_.isArray(e.parameter)){if(!_.isString(e.parameter))throw"taskDef must contain a 'parameter' property of either an array or a string type";t=e.parameter,e.parameter=[],e.parameter.push(t)}if(!_.isNumber(e.resolution))throw"taskDef must contain a 'resolution' property of numeric type";if(!(e.resolution>.5))throw"taskDef.resolution must be a positive integer";if(e.resolution=Math.round(e.resolution),!_.isNumber(e.start))throw"taskDef must contain a 'start' property of numeric type";if(_.isNumber(e.pointCount)){if(!(e.pointCount>0))throw"taskDef.pointCount must be greater than zero";e.end=e.start+(e.pointCount-1)*e.resolution}else{if(!_.isNumber(e.end))throw"taskDef must contain either 'end' or 'pointCount' property of numeric type";if(e.end<e.start)throw"'end' must be greater than or equal to 'start'";i=(e.end-e.start)%e.resolution,0!==i&&(e.end=e.end+(e.resolution-i)),e.pointCount=(e.end-e.start)/e.resolution+1}},t=function(e,t){var i=0;if(_.isArray(e)&&_.isArray(t)){if(e.length===t.length){for(i=0;e.length>i;i++)if(-1===_.indexOf(t,e[i]))return!1;return!0}return!1}return void 0===e||null===e||void 0===t||null===t?!1:e===t},i=function(){var t=0,i=function(i){function n(){o=null,a=null,c=null,s=null,u=0,l=!1,f=!1,h=!1,d=!1,m=!1,E=[]}var r=null,o=null,a=null,c=null,s=null,u=0,l=!1,f=!1,h=!1,d=!1,m=!1,E=[],p=i,R=this;this.getId=function(){return r},this.getTaskDef=function(){return s},this.getStart=function(){return null!==s?s.start:void 0},this.getEnd=function(){return null!==s?s.end:void 0},this.getPointCount=function(){return null!==s?s.pointCount:void 0},this.getResolution=function(){return null!==s?s.resolution:void 0},this.getService=function(){return null!==s?s.service:void 0},this.getLocation=function(){return null!==s?s.location:void 0},this.getParameter=function(){return null!==s?s.parameter:void 0},this.getDataSize=function(){return null!==s?s.pointCount*s.parameter.length*s.location.length:0},this.pin=function(){return d?!1:(h||(h=!0,p&&p("blockPinned",R)),!0)},this.unpin=function(){h&&(h=!1,p&&p("blockUnpinned",R))},this.isPinned=function(){return h},this.isWaitingRecycling=function(){return d},this.increaseNotUsed=function(){u++,p&&p("blockAged",R)},this.getNotUsedSince=function(){return u},this.markForRecycling=function(){d=!0,p&&p("blockEvicted",R)},this.recycle=function(){n(),p&&p("blockRecycled",R)},this.prepare=function(t,i){if(!_.isFunction(i))throw"fetcher must be a function";e(t),n(),s=t,a=i,m=!0,p&&p("blockPrepared",R)},this.getDataAsync=function(e){var t=this;if(!m)throw"Cannot getData in unprepared state, call prepare first";u=0,f?_.isFunction(e)?(_.defer(function(i,n){p&&p("blockCacheFetchFinished",R),e(i,n),t.unpin()},o,c),p&&p("blockCacheFetchStarted",R)):t.unpin():(void 0!==e&&_.isFunction(e)&&E.push(e),l||(l=!0,a(s,function(e,i){e&&(o=e),c=i,f=!0,p&&p("blockProviderFetchFinished",R),0===E.length?(l=!1,t.unpin()):async.each(E,function(e,i){try{e.call(t,o,c)}catch(n){}i()},function(){E=[],l=!1,t.unpin()})}),p&&p("blockProviderFetchStarted",R)))},r="id#"+t++,p&&p("blockCreated",R)};return i}(),n=0,r=0,o=function(o){function a(e,t){void 0!==X[e]&&_.each(X[e],function(e){try{e.call(C,t)}catch(i){}})}function c(e,t){var i=null;if(void 0===X[e])throw"Unknown event '"+e+"', use one of "+_.reduce(_.keys(X),function(e,t,i){return i>0&&(e+=", "),e+=t});if(!_.isFunction(t))throw"Event listener callback is not a function";return i="id"+n++,X[e][i]=t,i}function s(e,t){if(void 0===X[e])throw"Unknown event '"+e+"', use one of "+_.reduce(_.keys(X),function(e,t,i){i>0&&(e+=", "),e+=t});void 0!==X[e][t]&&delete X[e][t]}function u(e){async.each(e,function(e,t){e.markForRecycling(),t()},function(e){e&&console.error(e)})}function l(){var e;return e=v.length>0?v.pop():new i(a)}function f(e,t,i,n){var r=!1;return e===i&&t===n?r=!0:n>=e&&t>i&&(r=!0),r}function h(e,t,i,n,r,o){var a=null;return(0===e||i-o.resolution>t)&&i>n&&(a=i>=r?null===t?m(o,n,r):m(o,Math.max(t,n),r):null===t?m(o,n,i):m(o,Math.max(t,n),i)),a}function d(e){var i=[],n=e.start,r=e.end,o=Math.ceil(O*e.pointCount),c=Math.ceil(L*e.pointCount),s=n-o*e.resolution,l=r+c*e.resolution,d=[],E=[];return I=0,M.length>0&&_.each(M,function(n,r){var o=!1,a=null,c=null,u=0===r?null:M[r-1].getEnd(),p=n.getStart(),R=n.getEnd();if(n.isWaitingRecycling())return n.isPinned()?async.whilst(function(){return n.isPinned()},function(e){setTimeout(e,500)},function(){n.recycle(),v.push(n)}):(n.recycle(),v.push(n)),void 0;E.push(n),e.service===n.getService()&&t(e.location,n.getLocation())&&t(e.parameter,n.getParameter())?(a=h(r,u,p,s,l,e),null!==a&&a.length>0&&(Array.prototype.push.apply(E,a),async.reduce(a,b,function(e,t,i){i(null,e+t.getDataSize())},function(e,t){b=t}),Array.prototype.push.apply(i,a)),o=f(p,R,s,l),o?n.pin()?(i.push(n),A+=n.getDataSize()):console&&console.error("Strange, unable to pin block!"):n.increaseNotUsed(),r===M.length-1&&l>R&&(c=m(e,R,l),Array.prototype.push.apply(E,c),async.reduce(c,b,function(e,t,i){i(null,e+t.getDataSize())},function(e,t){b=t}),Array.prototype.push.apply(i,c))):n.increaseNotUsed();var T=_.sortedIndex(d,n,function(e){return e.getNotUsedSince()});d.splice(T,0,n),I+=n.getDataSize()}),0===i.length&&(i=m(e,s,l),Array.prototype.push.apply(E,i),async.reduce(i,b,function(e,t,i){i(null,e+t.getDataSize())},function(e,t){b=t})),M=[],M=E,E=[],async.whilst(function(){return 1.01*I>S},function(){var e=1.01*I-S;a("evictStarted",{inCache:I,toEvict:e});for(var t=[],i=null,n=0;e>n&&d.length>0;)i=d.pop(),void 0!==i&&(n+=i.getDataSize(),t.push(i));t.length>0&&(u(t),I-=n,a("evictFinished",{inCache:I,evicted:n}))},function(){}),i}function m(e,t,i){var n,r=[],o=Math.round((i-t)/e.resolution)+1,a=Math.ceil(o/g),c=0,s=null;for(c=0;a>c;c++)s=l(),n=_.clone(e),n.start=t+c*e.resolution*g,n.pointCount=Math.min(g,o-c*g),n.end=n.start+(n.pointCount-1)*e.resolution,s.prepare(n,R(e.service)),s.pin()?r.push(s):console.error("Strange, unable to pin block!");return r}function E(e,t,i,n,r,o,a,c){var s=_.isObject(t);async.each(i,function(i,c){void 0===e.data[i]&&(e.data[i]={}),async.each(n,function(n,c){var u=!1;void 0===e.data[i][n]&&(e.data[i][n]=[]),s&&(_.isObject(t[i])&&_.isArray(t[i][n])?o+a>t[i][n].length&&(u=!0,console&&console.error("The service returned "+t[i][n].length+" values for location "+i+" and parameter "+n+" when "+(o+a)+" were requested. Filling the whole segment with NaN")):u=!0);for(var l=0;a>l;l++)e.data[i][n][r+l]=s?u?0/0:t[i][n][o+l]:t;c()},function(){c()})},function(){c()})}function p(e,t,i){var n={},r=null,o=!1;if(!_.isFunction(t))throw"finishCallback must be a function";if(_.isFunction(i)&&(o=!0),null===R(e.service))throw"No data fetcher set for service '"+e.service+"', unable to provide data";void 0!==y[e.service]&&(y[e.service].resolution!==e.resolution||0!==Math.abs(y[e.service].start-e.start)%e.resolution)&&T(e.service),y[e.service]={start:e.start,resolution:e.resolution};var c=d(e);n.steps=_.range(e.start,e.end+e.resolution,e.resolution),n.data={},async.each(c,function(t,a){var c=t.getTaskDef(),s=0/0,u=0/0,l=0/0,h=0/0,d=0/0,m=0/0;return f(c.start,c.end,e.start,e.end)?(c.start<e.start?(s=e.start,d=Math.round((e.start-c.start)/e.resolution)):(s=c.start,d=0),l=_.indexOf(n.steps,s,!0),c.end>e.end?(u=e.end,h=n.steps.length-1):(u=c.end,h=_.indexOf(n.steps,c.end,!0)),m=h-l+1,t.getDataAsync(function(e,t){var f=t;e&&(null===r&&(r=[]),r.push({start:c.start,end:c.end,error:e}),t||(f=0/0)),E(n,f,c.location,c.parameter,l,d,m,function(){o&&i(e,s,u),a()})}),void 0):(t.getDataAsync(),a(),void 0)},function(){t(r,n),a("fetchFinished",e)})}function R(e){return void 0!==P[e]?(P[e].nextIndex=(P[e].nextIndex+1)%P[e].providers.length,P[e].providers[P[e].nextIndex].cb):null}function T(e){_.each(M,function(t){(void 0===e||t.getService()===e)&&t.markForRecycling()}),a("cacheCleared",e)}var v=[],M=[],y=[],O=.5,L=1,g=500,S=5e4,P={},I=0,A=0,b=0,C=this,X={blockCreated:{},blockPrepared:{},blockProviderFetchStarted:{},blockProviderFetchFinished:{},blockCacheFetchStarted:{},blockCacheFetchFinished:{},blockPinned:{},blockUnpinned:{},blockEvicted:{},blockRecycled:{},blockAged:{},evictStarted:{},evictFinished:{},fetchStarted:{},fetchFinished:{},cacheCleared:{},dataProviderAdded:{},dataProviderRemoved:{}};this.addDataProvider=function(e,t){var i={};if(!_.isFunction(t))throw"Fetcher must be a function";return void 0===P[e]&&(P[e]={nextIndex:0,providers:[]}),i.id="id#"+r++,i.cb=t,P[e].providers.push(i),a("dataProviderAdded",{service:e,providerId:i.id}),i.id},this.removeDataProvider=function(e,t){var i=0,n=!1;void 0!==P[e]&&(i=P[e].providers.length,P[e].providers=_.reject(P[e].providers,function(e){return e.id===t}),0===P[e].providers.length?(delete P.service,n=!0):i!==P[e].providers.length&&(n=!0),n&&a("dataProviderRemoved",{service:e,providerId:t}))},this.clearCache=function(){T(),y=[],A=0,b=0},this.fetch=function(t,i,n){e(t),a("fetchStarted",t),p(t,i,n)},this.getCachedItemCount=function(){return I},this.getFillingDegree=function(){return I/S},this.getHitRatio=function(){return A/(A+b)},this.addListener=function(e,t){return c(e,t)},this.removeListener=function(e,t){return s(e,t)},void 0!==o.sideFetchBeforeFactor&&_.isNumber(o.sideFetchBeforeFactor)&&o.sideFetchBeforeFactor>=0&&(O=o.sideFetchBeforeFactor),void 0!==o.sideFetchAfterFactor&&_.isNumber(o.sideFetchAfterFactor)&&o.sideFetchAfterFactor>=0&&(L=o.sideFetchAfterFactor),void 0!==o.maxBlockDataPoints&&_.isNumber(o.maxBlockDataPoints)&&o.maxBlockDataPoints>0&&(g=o.maxBlockDataPoints),void 0!==o.maxCacheDataSize&&_.isNumber(o.maxCacheDataSize)&&o.maxCacheDataSize>0&&(S=o.maxCacheDataSize)};return o}(),"undefined"==typeof jQuery||!jQuery)throw"ERROR: jQuery is required for fi.fmi.metoclient.metolib.WfsConnection!";if("undefined"==typeof _||!_)throw"ERROR: Underscore is required for fi.fmi.metoclient.metolib.WfsConnection!";if("undefined"==typeof async||!async)throw"ERROR: Async is required for fi.fmi.metoclient.metolib.WfsConnection!";var fi=fi||{};if(fi.fmi=fi.fmi||{},fi.fmi.metoclient=fi.fmi.metoclient||{},fi.fmi.metoclient.metolib=fi.fmi.metoclient.metolib||{},!fi.fmi.metoclient.metolib.Utils)throw"ERROR: fi.fmi.metoclient.metolib.Utils is required for fi.fmi.metoclient.metolib.WfsConnection!";if(!fi.fmi.metoclient.metolib.SplitterCache)throw"ERROR: fi.fmi.metoclient.metolib.SplitterCache is required for fi.fmi.metoclient.metolib.WfsConnection!";if(!fi.fmi.metoclient.metolib.WfsRequestParser)throw"ERROR: fi.fmi.metoclient.metolib.WfsRequestParser is required for fi.fmi.metoclient.metolib.WfsConnection!";fi.fmi.metoclient.metolib.WfsConnection=function(){function e(e){return jQuery.trim(e).replace(/,\s+/,l)}function t(t){var i=[];if(_.isString(t))i.push(e(t));else if(_.isArray(t))for(var n=0;t.length>n;++n){var r=t[n];r&&i.push(e(r))}return i}function i(e,t,i){var n=i;if(e&&e.location&&t&&i){var r=i+f,o=t.indexOf(r);0===o&&(t=jQuery.trim(t.slice(r.length)));for(var a=t+l+i,c=0;e.location.length>c;++c){var s=e.location[c];if(-1!==s.indexOf(l)&&s===a){n=s;break}}}return n}function n(e,t){if(_.isArray(e)&&t&&t>0)for(var i=1;e.length>i;++i){var n=e[i-1],r=e[i];if(_.isObject(r)){var o=_.isObject(n)?n.time:void 0,a=r.time;void 0!==o&&null!==o&&void 0!==a&&null!==a&&a-o>t&&(a=o+t,e.splice(i,0,{time:a,value:0/0})),o=a}}}function r(e,t){return _.find(e,function(e){return _.isEqual(e,t)})}function o(e){var t=[];if(_.isArray(e))for(var i=0;e.length>i;++i){var n=e[i],o=_.isObject(n)&&(n.errorCode||n.errorText);if(_.isObject(n)&&_.isArray(n.error)&&n.error.length>0)for(var a=n.error,c=0;a.length>c;++c){var s=a[c];if(_.isObject(s)&&(s.errorCode||s.errorText)){var u={errorCode:s.errorCode,errorText:s.errorText,extension:n};r(t,u)||t.push(u)}else o=!0}else o=!0;if(o){var l={errorCode:_.isObject(n)?n.errorCode:void 0,errorText:_.isObject(n)&&_.isString(n.errorText)?n.errorText:h,extension:n};
r(t,l)||t.push(l)}}return t}function a(e,t,r){var o={data:t?{}:void 0,errors:r};return t&&_.each(t.locations,function(r){var a=i(e,r.info.name,r.info.region);o.data[a]||(o.data[a]={}),_.each(r.data,function(i,c){o.data[a][c]||(o.data[a][c]=[]),n(i.timeValuePairs,e.resolution),_.each(i.timeValuePairs,function(e){var n={info:t.info,properties:t.properties,locationInfo:r.info,blockProperty:i.property,timeValuePair:e};o.data[a][c].push(n)})})}),o}function c(e,t,i){var n={data:t?{info:void 0,properties:void 0,locations:[]}:void 0,errors:o(i)};return t&&_.each(t.data,function(e){var t={info:void 0,data:{}};_.each(e,function(e,i){var r={property:void 0,timeValuePairs:[]};_.each(e,function(e){e&&(n.data.info||(n.data.info=e.info),n.data.properties||(n.data.properties=e.properties),r.property||(r.property=e.blockProperty),t.info||(t.info=e.locationInfo),r.timeValuePairs.push(e.timeValuePair))}),t.data[i]=r}),n.data.locations.push(t)}),n}function s(e,t,i){fi.fmi.metoclient.metolib.WfsRequestParser.getData({url:e.connectionUrl,storedQueryId:e.storedQueryId,requestParameter:t.parameter,begin:t.start,end:t.end,timestep:t.resolution,denyTimeAdjusting:!0,sites:t.location,callback:function(n,r){var o=a.call(e,t,n,r);i(o.errors,o.data)}})}var u="parserSites",l=",",f=" ",h="ERROR: Cache found error(s)!",d=function(e){if(e.timestep&&1!==e.timestep){var i=e.begin,n=e.end,r=e.timestep;e.denyTimeAdjusting||(i=fi.fmi.metoclient.metolib.WfsRequestParser.adjustBeginTime(r,i),n=fi.fmi.metoclient.metolib.WfsRequestParser.adjustEndTime(r,n,i));var o={service:u,parameter:_.isString(e.requestParameter)?e.requestParameter.split(l):e.requestParameter,start:i instanceof Date?i.getTime():i,end:n instanceof Date?n.getTime():n,resolution:r,location:t(e.sites)};this.cache.fetch(o,function(t,i){var n=c(o,i,t);e.callback(n.data,n.errors)},e.progressCallback)}else{var a=this;fi.fmi.metoclient.metolib.WfsRequestParser.getData({url:a.connectionUrl,storedQueryId:a.storedQueryId,requestParameter:e.requestParameter,begin:e.begin,end:e.end,timestep:e.timestep,denyTimeAdjusting:e.denyTimeAdjusting,sites:t(e.sites),callback:e.callback})}},m=function(e){var t=this;fi.fmi.metoclient.metolib.WfsRequestParser.getData({url:t.connectionUrl,storedQueryId:t.storedQueryId,requestParameter:e.requestParameter,begin:e.begin,end:e.end,timestep:e.timestep,denyTimeAdjusting:e.denyTimeAdjusting,bbox:e.bbox,callback:e.callback})},E=function(e,t){var i=!0;try{var n=Array.prototype.slice.call(arguments);n.shift(),n.shift(),e.apply(this,n)}catch(r){var o="ERROR: API level error occurred in a synchronous flow!";if(console.error(o),i=!1,t){var a={errorText:o};t(void 0,a)}}return i},p=function(){return this.connectionUrl},R=function(){return this.storedQueryId},T=function(e,t){if(!this.connectionUrl){if(!_.isString(e)||!e){var i="ERROR: WfsConnection URL must be a string and not empty!";throw console.error(i),i}if(!_.isString(t)||!t){var n="ERROR: WfsConnection stored query ID must be a string and not empty!";throw console.error(n),n}this.connectionUrl=e,this.storedQueryId=t}},v=function(){this.connectionUrl=void 0,this.storedQueryId=void 0,M.call(this)},M=function(){this.cache.clearCache()},y=function(e){if(!e){var t="ERROR: Options object is mandatory!";throw console.error(t),t}if(e.sites)d.call(this,e);else{if(!e.bbox){var i="ERROR: Either sites or bbox is mandatory in options!";throw console.error(i),i}m.call(this,e)}},O=function(){var e=this,t={connectionInstance:e,connectionUrl:void 0,storedQueryId:void 0,cache:new fi.fmi.metoclient.metolib.SplitterCache({sideFetchAfterFactor:1,sideFetchBeforeFactor:.5,maxBlockDataPoints:200,maxCacheDataSize:4e3})};t.cache.addDataProvider(u,function(e,i){s(t,e,i)}),this.getUrl=function(){return p.call(t)},this.getStoredQueryId=function(){return R.call(t)},this.connect=function(e,i){return E.call(t,T,void 0,e,i)},this.disconnect=function(){return E.call(t,v,void 0)},this.resetCache=function(){return E.call(t,M,void 0)},this.getData=function(e){return E.call(t,y,e?e.callback:void 0,e)}};return O}();